---
/* 
  Lightbox Component
  - Auto-attaches to images within a specified selector or globally if none provided.
  - Handles opening, closing, and basic accessibility.
*/
import "../../styles/lightbox.css";
import IconBulb from "../icons/IconBulb.astro";

interface Props {
  selector?: string; // CSS selector to scope image listeners (e.g., '.post-content')
  gallery?: boolean; // Whether to allow cycling through images
}

const { selector = "main", gallery = true } = Astro.props;
---

<div id="lightbox" class="lightbox" aria-hidden="true" data-gallery={gallery.toString()}>
  <div class="lightbox-overlay"></div>
  
  <div class="lightbox-main">
    <figure class="lightbox-figure">
      <img id="lightbox-img" class="lightbox-img" src="" alt="" />
    </figure>
  </div>

  <aside class="lightbox-sidebar">
    <div class="sidebar-content">
      <div id="lightbox-meta" class="lightbox-meta">
        <h3 id="lightbox-caption" class="lightbox-caption"></h3>
        <div id="lightbox-exif" class="lightbox-exif"></div>
      </div>
    </div>

    <div class="sidebar-footer">
      <div class="control-group">
        {gallery && (
          <>
            <button id="lightbox-prev" class="icon-btn" aria-label="Previous image">
               <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            </button>
            <button id="lightbox-next" class="icon-btn" aria-label="Next image">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg>
            </button>
          </>
        )}
        <button id="toggle-lights" class="icon-btn" aria-label="Toggle Lights">
          <IconBulb />
        </button>
        <button id="lightbox-close" class="icon-btn" aria-label="Close">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
    </div>
  </aside>
</div>

<script define:vars={{ selector, gallery }}>
  const lightbox = document.getElementById("lightbox");
  const img = document.getElementById("lightbox-img");
  const caption = document.getElementById("lightbox-caption");
  const closeBtn = document.getElementById("lightbox-close");
  const prevBtn = document.getElementById("lightbox-prev");
  const nextBtn = document.getElementById("lightbox-next");
  const overlay = document.querySelector(".lightbox-overlay");
  const toggleLightsBtn = document.getElementById("toggle-lights");
  const metaContainer = document.getElementById("lightbox-meta");
  const exifContainer = document.getElementById("lightbox-exif");

  let currentImages = [];
  let currentIndex = -1;
  let isTransitioning = false;

  if (lightbox && img && caption && closeBtn && overlay) {

    const updateCaptionAndMeta = (target) => {
       // Look for figcaption if inside figure
      let capText = "";
      const fig = target.closest("figure");
      if (fig) {
        const cap = fig.querySelector("figcaption");
        if (cap) capText = cap.textContent;
      }
      caption.textContent = capText || target.alt || "";

      // Placeholder for EXIF - could be expanded to fetch real EXIF
      if (exifContainer) {
        exifContainer.innerHTML = `
          <p>Dimensions: ${target.naturalWidth} x ${target.naturalHeight}</p>
          <p>Format: ${target.src.split('.').pop().toUpperCase()}</p>
        `;
      }
    };

    const updateLightbox = (index, withTransition = false) => {
      if (index < 0 || index >= currentImages.length) return;
      
      const target = currentImages[index];
      
      // Determine orientation for sizing
      const isVertical = target.naturalHeight > target.naturalWidth;
      lightbox.setAttribute("data-orientation", isVertical ? "vertical" : "horizontal");

      updateCaptionAndMeta(target);

      if (withTransition && !isTransitioning) {
        isTransitioning = true;
        
        // 1. Fade Out
        img.style.opacity = '0';
        
        setTimeout(() => {
            // 2. Swap Source
            img.src = target.src;
            img.alt = target.alt || "";
            
            const onImageLoad = () => {
                // 3. Fade In
                requestAnimationFrame(() => {
                    img.style.opacity = '1';
                    setTimeout(() => {
                        isTransitioning = false;
                        
                        // Preload next image
                        const lookaheadIndex = (index + 1) % currentImages.length;
                        if (lookaheadIndex !== index) {
                            const preloadImg = new Image();
                            preloadImg.src = currentImages[lookaheadIndex].src;
                        }
                    }, 300);
                });
            };

            if (img.complete) {
                onImageLoad();
            } else {
                img.onload = onImageLoad;
                img.onerror = () => {
                    console.error('Failed to load image');
                    isTransitioning = false;
                };
            }
        }, 300); // Wait for fade out

      } else {
        // Instant update
        img.style.opacity = '0';
        img.src = target.src;
        img.alt = target.alt || "";
        
        const showImage = () => {
            img.style.opacity = '1';
            
            // Preload next
            const lookaheadIndex = (index + 1) % currentImages.length;
            if (lookaheadIndex !== index && currentImages.length > 0) {
                 const preloadImg = new Image();
                 preloadImg.src = currentImages[lookaheadIndex].src;
            }
        };

        if (img.complete) {
            requestAnimationFrame(showImage);
        } else {
            img.onload = showImage;
        }
      }

      currentIndex = index;
    };

    // Add click-to-next
    img.addEventListener('click', (e) => {
        e.stopPropagation();
        if (gallery && currentImages.length > 1) {
            nextImage();
        }
    });
    img.style.cursor = gallery ? "pointer" : "default";

    if (toggleLightsBtn && metaContainer) {
      toggleLightsBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        const isLightsOn = lightbox.classList.toggle("lights-on");
        const isLightsOff = !isLightsOn;
        
        if (isLightsOff) {
          lightbox.classList.add("lights-off");
          metaContainer.classList.add("is-active"); 
          toggleLightsBtn.classList.remove("active");
        } else {
          lightbox.classList.remove("lights-off");
          metaContainer.classList.add("is-active");
          toggleLightsBtn.classList.add("active");
        }
      });
    }

    const openLightbox = (imageElement) => {
      if (!gallery) return;

      const container = document.querySelector(selector);
      if (!container) return;
      
      currentImages = Array.from(container.querySelectorAll("img")).filter(i => {
        return !i.closest("a") && !i.classList.contains("no-lightbox");
      });
      currentIndex = currentImages.indexOf(imageElement);

      if (currentIndex === -1) return;

      // Reset
      img.style.opacity = '0';
      img.removeAttribute('src');

      updateLightbox(currentIndex, false); 
      lightbox.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
      document.body.classList.add("lightbox-open");
      document.body.classList.add("toc-hidden");
      
      // Default: Lights On
      lightbox.classList.add("lights-on");
      lightbox.classList.remove("lights-off");
      if (metaContainer) metaContainer.classList.add("is-active");
      if (toggleLightsBtn) toggleLightsBtn.classList.add("active");
    };

    const closeLightbox = () => {
      lightbox.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
      document.body.classList.remove("lightbox-open");
      document.body.classList.remove("toc-hidden");
      
      setTimeout(() => {
          img.removeAttribute('src');
          img.style.opacity = '0';
          isTransitioning = false;
      }, 300);
    };

    const mainArea = document.querySelector(".lightbox-main");
    if (mainArea) {
      mainArea.addEventListener("click", (e) => {
        if (e.target === mainArea || e.target === document.querySelector(".lightbox-figure")) {
          closeLightbox();
        }
      });
    }

    const nextImage = () => {
      if (isTransitioning) return;
      if (currentIndex < currentImages.length - 1) {
        updateLightbox(currentIndex + 1, true);
      } else if (currentImages.length > 1) {
        updateLightbox(0, true);
      }
    };

    const prevImage = () => {
      if (isTransitioning) return;
      if (currentIndex > 0) {
        updateLightbox(currentIndex - 1, true);
      } else if (currentImages.length > 1) {
        updateLightbox(currentImages.length - 1, true);
      }
    };

    const attachListeners = () => {
      if (!gallery) return;

      const container = document.querySelector(selector);
      if (!container) return;

      const images = container.querySelectorAll("img");
      images.forEach((image) => {
        if (image.closest("a")) return;
        if (image.classList.contains("no-lightbox")) return;

        image.style.cursor = "zoom-in";
        image.addEventListener("click", (e) => {
          e.stopPropagation();
          openLightbox(image);
        });
      });
    };

    attachListeners();
    document.addEventListener("astro:page-load", attachListeners);

    closeBtn.addEventListener("click", closeLightbox);
    overlay.addEventListener("click", closeLightbox);
    
    if (gallery && prevBtn && nextBtn) {
      prevBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        prevImage();
      });
      nextBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        nextImage();
      });
    }

    document.addEventListener("keydown", (e) => {
      if (lightbox.getAttribute("aria-hidden") === "true") return;

      if (e.key === "Escape") closeLightbox();
      if (gallery) {
        if (e.key === "ArrowRight") nextImage();
        if (e.key === "ArrowLeft") prevImage();
      }
    });
  }
</script>
