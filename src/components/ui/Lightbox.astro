---
/* 
  Lightbox Component
  - Auto-attaches to images within a specified selector or globally if none provided.
  - Handles opening, closing, and basic accessibility.
*/
interface Props {
  selector?: string; // CSS selector to scope image listeners (e.g., '.post-content')
  gallery?: boolean; // Whether to allow cycling through images
}

const { selector = "main", gallery = true } = Astro.props;
---

<div id="lightbox" class="lightbox" aria-hidden="true">
  <div class="lightbox-overlay"></div>
  <figure class="lightbox-figure">
    <img id="lightbox-img" src="" alt="" />
    <figcaption id="lightbox-caption"></figcaption>
  </figure>
  
  <button id="lightbox-close" class="lightbox-ctrl close" aria-label="Close lightbox">&times;</button>
  
  {gallery && (
    <div class="lightbox-nav">
      <button id="lightbox-prev" class="lightbox-ctrl prev" aria-label="Previous image">&lsaquo;</button>
      <button id="lightbox-next" class="lightbox-ctrl next" aria-label="Next image">&rsaquo;</button>
    </div>
  )}
</div>

<script define:vars={{ selector, gallery }}>
  const lightbox = document.getElementById("lightbox");
  const img = document.getElementById("lightbox-img");
  const caption = document.getElementById("lightbox-caption");
  const closeBtn = document.getElementById("lightbox-close");
  const prevBtn = document.getElementById("lightbox-prev");
  const nextBtn = document.getElementById("lightbox-next");
  const overlay = document.querySelector(".lightbox-overlay");

  let currentImages = [];
  let currentIndex = -1;

  if (lightbox && img && caption && closeBtn && overlay) {
    const updateLightbox = (index) => {
      if (index < 0 || index >= currentImages.length) return;
      currentIndex = index;
      const target = currentImages[currentIndex];
      
      img.src = target.src;
      img.alt = target.alt || "";
      
      // Look for figcaption if inside figure
      let capText = "";
      const fig = target.closest("figure");
      if (fig) {
        const cap = fig.querySelector("figcaption");
        if (cap) capText = cap.textContent;
      }
      caption.textContent = capText || target.alt || "";
    };

    const openLightbox = (imageElement) => {
      if (gallery) {
        const container = document.querySelector(selector);
        currentImages = Array.from(container.querySelectorAll("img")).filter(i => {
          return !i.closest("a") && !i.classList.contains("no-lightbox");
        });
        currentIndex = currentImages.indexOf(imageElement);
      } else {
        currentImages = [imageElement];
        currentIndex = 0;
      }

      updateLightbox(currentIndex);
      lightbox.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
      closeBtn.focus();
    };

    const closeLightbox = () => {
      lightbox.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
      img.src = "";
    };

    const nextImage = () => {
      if (currentIndex < currentImages.length - 1) {
        updateLightbox(currentIndex + 1);
      } else if (currentImages.length > 1) {
        updateLightbox(0); // Loop to start
      }
    };

    const prevImage = () => {
      if (currentIndex > 0) {
        updateLightbox(currentIndex - 1);
      } else if (currentImages.length > 1) {
        updateLightbox(currentImages.length - 1); // Loop to end
      }
    };

    const attachListeners = () => {
      const container = document.querySelector(selector);
      if (!container) return;

      const images = container.querySelectorAll("img");
      images.forEach((image) => {
        if (image.closest("a")) return;
        if (image.classList.contains("no-lightbox")) return;

        image.style.cursor = "zoom-in";
        image.addEventListener("click", (e) => {
          e.stopPropagation();
          openLightbox(image);
        });
      });
    };

    attachListeners();
    document.addEventListener("astro:page-load", attachListeners);

    closeBtn.addEventListener("click", closeLightbox);
    overlay.addEventListener("click", closeLightbox);
    
    if (gallery && prevBtn && nextBtn) {
      prevBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        prevImage();
      });
      nextBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        nextImage();
      });
    }

    document.addEventListener("keydown", (e) => {
      if (lightbox.getAttribute("aria-hidden") === "true") return;

      if (e.key === "Escape") closeLightbox();
      if (gallery) {
        if (e.key === "ArrowRight") nextImage();
        if (e.key === "ArrowLeft") prevImage();
      }
    });
  }
</script>

<style>
  .lightbox {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }

  .lightbox[aria-hidden="false"] {
    opacity: 1;
    pointer-events: auto;
  }

  .lightbox-overlay {
    position: absolute;
    inset: 0;
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(10px);
  }

  .lightbox-figure {
    position: relative;
    z-index: 10;
    max-width: 90vw;
    max-height: 90vh;
    margin: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .lightbox-figure img {
    max-width: 100%;
    max-height: 82vh;
    object-fit: contain;
    box-shadow: 0 20px 50px rgba(0,0,0,0.1);
    border-radius: 2px;
  }

  .lightbox-figure figcaption {
    margin-top: 1.5rem;
    font-family: "DM Sans", sans-serif;
    color: var(--ink, #111);
    font-size: 1.1rem;
    text-align: center;
    max-width: 600px;
  }

  .lightbox-ctrl {
    position: absolute;
    background: none;
    border: none;
    color: var(--muted, #555);
    cursor: pointer;
    transition: color 0.2s, transform 0.2s;
    z-index: 20;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }

  .lightbox-ctrl:hover {
    color: var(--ink, #000);
    transform: scale(1.1);
  }

  .lightbox-ctrl.close {
    top: 2rem;
    right: 2rem;
    font-size: 3rem;
    line-height: 1;
  }

  .lightbox-ctrl.prev,
  .lightbox-ctrl.next {
    top: 50%;
    transform: translateY(-50%);
    font-size: 4rem;
    width: 6rem;
    height: 8rem;
  }

  .lightbox-ctrl.prev { left: 1rem; }
  .lightbox-ctrl.next { right: 1rem; }

  @media (max-width: 768px) {
    .lightbox-ctrl.prev,
    .lightbox-ctrl.next {
      width: 4rem;
      font-size: 3rem;
    }
    .lightbox-ctrl.close {
      top: 1rem;
      right: 1rem;
    }
  }
</style>
