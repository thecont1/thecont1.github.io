---
/* 
  Lightbox Component
  - Auto-attaches to images within a specified selector or globally if none provided.
  - Handles opening, closing, and basic accessibility.
*/
import "../../styles/lightbox.css";
import IconBulb from "../icons/IconBulb.astro";
import IconCR from "../icons/IconCR.astro";

interface Props {
  selector?: string; // CSS selector to scope image listeners (e.g., '.post-content')
  gallery?: boolean; // Whether to allow cycling through images
}

const { selector = "main", gallery = true } = Astro.props;
---

<div id="lightbox" class="lightbox" aria-hidden="true" data-selector={selector} data-gallery={gallery.toString()}>
  <div class="lightbox-overlay"></div>
  
  <div class="lightbox-main">
    <figure class="lightbox-figure">
      <img id="lightbox-img" class="lightbox-img" src="" alt="" />
      <img id="lightbox-img-2" class="lightbox-img" src="" alt="" />
    </figure>
  </div>

  <aside class="lightbox-sidebar">
    <div class="sidebar-content">
      <div id="lightbox-meta" class="lightbox-meta">
        <h3 id="lightbox-caption" class="lightbox-caption"></h3>
        <div id="lightbox-exif" class="lightbox-exif"></div>
      </div>
    </div>

    <div class="sidebar-footer">
      <div class="control-group">
        {gallery && (
          <>
            <button id="lightbox-prev" class="icon-btn" aria-label="Previous image">
               <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            </button>
            <button id="lightbox-next" class="icon-btn" aria-label="Next image">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg>
            </button>
          </>
        )}
        <button id="toggle-lights" class="icon-btn" aria-label="Toggle Lights">
          <IconBulb />
        </button>
        <button id="lightbox-c2pa" class="icon-btn" aria-label="View Content Credentials">
          <IconCR width="20" height="20" />
        </button>
        <button id="lightbox-close" class="icon-btn" aria-label="Close">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
    </div>
  </aside>
</div>

<script>
  function initLightbox() {
    const lightbox = document.getElementById("lightbox");
    if (!lightbox) return;

    // If already initialized, only re-attach listeners to in-page images.
    if (lightbox.dataset.initialized === 'true') {
      if (typeof window.__attachLightboxListeners === 'function') {
        window.__attachLightboxListeners();
      }
      return;
    }

    const gallery = lightbox.dataset.gallery === "true";
    const selector = lightbox.dataset.selector || "main";
    const lightboxImages = document.querySelectorAll(".lightbox-img");
    const caption = document.getElementById("lightbox-caption");
    const closeBtn = document.getElementById("lightbox-close");
    const prevBtn = document.getElementById("lightbox-prev");
    const nextBtn = document.getElementById("lightbox-next");
    const overlay = document.querySelector(".lightbox-overlay");
    const toggleLightsBtn = document.getElementById("toggle-lights");
    const metaContainer = document.getElementById("lightbox-meta");
    const exifContainer = document.getElementById("lightbox-exif");
    const c2paBtn = document.getElementById("lightbox-c2pa");

    if (!lightbox || !caption || !closeBtn || !overlay) return;

    let currentImages = [];
    let currentIndex = -1;
    let activeImgIndex = 0;
    let isTransitioning = false;

    const getMetadata = async (imgUrl) => {
      try {
        const url = new URL(imgUrl, window.location.origin);
        const imagePath = url.pathname;
        const pathParts = imagePath.split('/');
        const filename = pathParts[pathParts.length - 1];
        const originalsIndex = pathParts.indexOf('originals');
        if (originalsIndex === -1 || originalsIndex >= pathParts.length - 2) return {};
        
        const directory = pathParts[originalsIndex + 1];
        const metadataUrl = `https://pub-94814f577b9949a59be8bf7b24fd4963.r2.dev/originals/${directory}/metadata.json`;
        
        const response = await fetch(metadataUrl);
        if (!response.ok) return {};
        
        const directoryMetadata = await response.json();
        return directoryMetadata[filename] || {};
      } catch (e) {
        return {};
      }
    };

    const updateCaptionAndMeta = async (targetImgEl) => {
      let capText = "";
      const fig = targetImgEl.closest("figure");
      if (fig) {
        const cap = fig.querySelector("figcaption");
        if (cap) capText = cap.textContent;
      }
      
      let initialCaption = capText || targetImgEl.alt || "Untitled";
      caption.textContent = initialCaption;

      if (exifContainer) {
        exifContainer.innerHTML = '<p class="loading-meta">Fetching metadata...</p>';
        try {
          const data = await getMetadata(targetImgEl.src);
          if (!capText && data?.exif?.ImageDescription) {
            const imageDesc = data.exif.ImageDescription;
            if (imageDesc && imageDesc.length > 10) caption.textContent = imageDesc;
          }
          
          if (data && !data.error && (data.exif || data.photography)) {
            let exifHtml = '';
            if (data.photography) {
              const photo = data.photography;
              if (photo.camera_make || photo.camera_model) {
                exifHtml += `<p class="exif-row"><strong>Camera:</strong> ${[photo.camera_make, photo.camera_model].filter(Boolean).join(' ')}</p>`;
              }
              if (photo.lens_model) exifHtml += `<p class="exif-row"><strong>Lens:</strong> ${photo.lens_model}</p>`;
              const settings = [photo.shutter_speed, photo.aperture, photo.iso ? `ISO ${photo.iso}` : '', photo.focal_length].filter(Boolean).join('  •  ');
              if (settings) exifHtml += `<p class="exif-row"><strong>Settings:</strong> ${settings}</p>`;
              const date = photo.date_original || photo.date_taken;
              if (date) exifHtml += `<p class="exif-row"><strong>Date Taken:</strong> ${date}</p>`;
              if (photo.artist) exifHtml += `<p class="exif-row"><strong>Artist:</strong> ${photo.artist}</p>`;
              if (photo.copyright) exifHtml += `<p class="exif-row"><strong>Copyright:</strong> ${photo.copyright}</p>`;
            }
            if (data.width && data.height) exifHtml += `<p class="exif-row"><strong>Dimensions:</strong> ${data.width} × ${data.height}</p>`;
            if (data.format) exifHtml += `<p class="exif-row"><strong>Format:</strong> ${data.format}</p>`;
            exifContainer.innerHTML = exifHtml || `<p class="exif-row"><strong>Dimensions:</strong> ${targetImgEl.naturalWidth} × ${targetImgEl.naturalHeight}</p>`;
          } else {
            exifContainer.innerHTML = `<p class="exif-row"><strong>Dimensions:</strong> ${targetImgEl.naturalWidth} x ${targetImgEl.naturalHeight}</p><p class="exif-row"><strong>Format:</strong> ${targetImgEl.src.split('.').pop().toUpperCase()}</p>`;
          }
        } catch (err) {
          exifContainer.innerHTML = `<p>Metadata unavailable</p>`;
        }
      }
    };

    const updateLightbox = (index, withTransition = false) => {
      if (index < 0 || index >= currentImages.length) return;
      const target = currentImages[index];
      const isVertical = target.naturalHeight > target.naturalWidth;
      lightbox.setAttribute("data-orientation", isVertical ? "vertical" : "horizontal");
      const currentImgEl = lightboxImages[activeImgIndex] as HTMLImageElement;

      if (withTransition && !isTransitioning) {
        isTransitioning = true;
        currentImgEl.style.opacity = '0';
        setTimeout(() => {
          currentImgEl.src = target.src;
          currentImgEl.alt = target.alt || "";
          const completeTransition = () => {
            updateCaptionAndMeta(currentImgEl);
            requestAnimationFrame(() => {
              currentImgEl.style.opacity = '1';
              setTimeout(() => { isTransitioning = false; }, 300);
            });
          };
          if (currentImgEl.complete) completeTransition();
          else {
            currentImgEl.onload = completeTransition;
            currentImgEl.onerror = () => { isTransitioning = false; };
          }
        }, 300);
      } else {
        currentImgEl.style.opacity = '0';
        currentImgEl.src = target.src;
        currentImgEl.alt = target.alt || "";
        const showImage = () => {
          updateCaptionAndMeta(currentImgEl);
          currentImgEl.style.opacity = '1';
        };
        if (currentImgEl.complete) requestAnimationFrame(showImage);
        else currentImgEl.onload = showImage;
      }
      currentIndex = index;
    };

    const openLightbox = (imageElement) => {
      const container = document.querySelector(selector);
      if (!container) return;

      if (gallery) {
        currentImages = Array.from(container.querySelectorAll("img")).filter(i => !i.closest("a") && !i.classList.contains("no-lightbox"));
        currentIndex = currentImages.indexOf(imageElement);
      } else {
        currentImages = [imageElement];
        currentIndex = 0;
      }

      if (currentIndex === -1) return;

      lightboxImages.forEach(img => {
        img.classList.remove('active', 'next');
        img.removeAttribute('src');
      });
      activeImgIndex = 0;

      updateLightbox(currentIndex, false);
      lightbox.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
      document.body.classList.add("lightbox-open", "toc-hidden");
      lightbox.classList.add("lights-on");
      lightbox.classList.remove("lights-off");
      if (metaContainer) metaContainer.classList.add("is-active");
      if (toggleLightsBtn) toggleLightsBtn.classList.add("active");
    };

    const closeLightbox = () => {
      lightbox.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
      document.body.classList.remove("lightbox-open", "toc-hidden");
      setTimeout(() => {
        lightboxImages.forEach(img => {
          img.removeAttribute('src');
          img.classList.remove('active', 'next');
        });
        isTransitioning = false;
      }, 300);
    };

    const nextImage = () => {
      if (isTransitioning) return;
      if (currentIndex < currentImages.length - 1) updateLightbox(currentIndex + 1, true);
      else if (currentImages.length > 1) updateLightbox(0, true);
    };

    const prevImage = () => {
      if (isTransitioning) return;
      if (currentIndex > 0) updateLightbox(currentIndex - 1, true);
      else if (currentImages.length > 1) updateLightbox(currentImages.length - 1, true);
    };

    const attachListeners = () => {
      const container = document.querySelector(selector);
      if (!container) return;
      
      const images = container.querySelectorAll("img");
      
      images.forEach((image) => {
        if (image.closest("a") || image.classList.contains("no-lightbox")) return;
        image.style.cursor = "zoom-in";
        
        image.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          openLightbox(image);
        };
      });
    };

    // Expose for subsequent Astro page transitions without re-initializing controls.
    window.__attachLightboxListeners = attachListeners;

    // Initialize
    attachListeners();
    
    // Support Astro ViewTransitions
    document.addEventListener("astro:page-load", attachListeners);
    document.addEventListener("astro:after-swap", attachListeners);
    
    // Fallback for dynamically added content
    const observer = new MutationObserver(attachListeners);
    observer.observe(document.body, { childList: true, subtree: true });
    closeBtn.addEventListener("click", closeLightbox);
    overlay.addEventListener("click", closeLightbox);
    
    if (gallery && prevBtn && nextBtn) {
      prevBtn.addEventListener("click", (e) => { e.stopPropagation(); prevImage(); });
      nextBtn.addEventListener("click", (e) => { e.stopPropagation(); nextImage(); });
    }

    if (toggleLightsBtn) {
      toggleLightsBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        const isCurrentlyOff = lightbox.classList.contains("lights-off");
        
        if (isCurrentlyOff) {
          // Turn lights ON
          lightbox.classList.remove("lights-off");
          lightbox.classList.add("lights-on");
          toggleLightsBtn.classList.add("active");
        } else {
          // Turn lights OFF
          lightbox.classList.add("lights-off");
          lightbox.classList.remove("lights-on");
          toggleLightsBtn.classList.remove("active");
        }
      });
    }

    if (c2paBtn) {
      c2paBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        const currentImgEl = lightboxImages[activeImgIndex] as HTMLImageElement;
        if (currentImgEl?.src) window.dispatchEvent(new CustomEvent('open-c2pa', { detail: { imgSrc: currentImgEl.src } }));
      });
    }

    const mainArea = document.querySelector(".lightbox-main");
    if (mainArea) {
      mainArea.addEventListener("click", (e) => {
        if (e.target === mainArea || e.target === document.querySelector(".lightbox-figure")) closeLightbox();
      });
    }

    document.addEventListener("keydown", (e) => {
      if (lightbox.getAttribute("aria-hidden") === "true") return;
      if (e.key === "Escape") closeLightbox();
      if (gallery) {
        if (e.key === "ArrowRight") nextImage();
        if (e.key === "ArrowLeft") prevImage();
      }
    });

    lightbox.dataset.initialized = 'true';
  }

  initLightbox();
  document.addEventListener("astro:page-load", initLightbox);
</script>
