---
import "../../styles/lightbox.css";
import "../../styles/info-panel.css";
import IconBulb from "../icons/IconBulb.astro";
import IconCR from "../icons/IconCR.astro";

interface Props {
  selector?: string; // CSS selector to scope image listeners (e.g., '.post-content')
  gallery?: boolean; // Whether to allow cycling through images
  includeHero?: boolean; // Whether to include hero image in gallery
}

const { selector = "main", gallery = true, includeHero = false } = Astro.props;
---

<div id="lightbox" class="lightbox" aria-hidden="true" data-selector={selector} data-gallery={gallery.toString()} data-include-hero={includeHero.toString()}>
  <div class="lightbox-overlay"></div>
  
  <div class="lightbox-main">
    <figure class="lightbox-figure">
      <img id="lightbox-img" class="lightbox-img" src="" alt="" />
      <img id="lightbox-img-2" class="lightbox-img" src="" alt="" />
    </figure>
  </div>

  <aside class="lightbox-sidebar">
    <div class="sidebar-content">
      <div id="lightbox-meta" class="lightbox-meta">
        <div id="lightbox-exif" class="lightbox-exif"></div>
      </div>
    </div>

    <div class="sidebar-footer">
      <div class="control-group">
        {gallery && (
          <>
            <button id="lightbox-prev" class="icon-btn" aria-label="Previous image">
               <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            </button>
            <button id="lightbox-next" class="icon-btn" aria-label="Next image">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg>
            </button>
          </>
        )}
        <button id="toggle-lights" class="icon-btn" aria-label="Toggle Lights">
          <IconBulb />
        </button>
        <button id="lightbox-c2pa" class="icon-btn" aria-label="View Content Credentials">
          <IconCR width="20" height="20" />
        </button>
        <button id="lightbox-close" class="icon-btn" aria-label="Close">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
    </div>
  </aside>
</div>

<script>
  import { openC2PAOverlay } from "../../utils/c2pa.js";
  
  function initLightbox() {
    const lightbox = document.getElementById("lightbox");
    if (!lightbox) return;

    // If already initialized, only re-attach listeners to in-page images.
    if (lightbox.dataset.initialized === 'true') {
      if (typeof window.__attachLightboxListeners === 'function') {
        window.__attachLightboxListeners();
      }
      return;
    }

    const gallery = lightbox.dataset.gallery === "true";
    const selector = lightbox.dataset.selector || "main";
    const includeHero = lightbox.dataset.includeHero === "true";
    const lightboxImages = document.querySelectorAll(".lightbox-img");
    const closeBtn = document.getElementById("lightbox-close");
    const prevBtn = document.getElementById("lightbox-prev");
    const nextBtn = document.getElementById("lightbox-next");
    const overlay = document.querySelector(".lightbox-overlay");
    const toggleLightsBtn = document.getElementById("toggle-lights");
    const metaContainer = document.getElementById("lightbox-meta");
    const exifContainer = document.getElementById("lightbox-exif");
    const c2paBtn = document.getElementById("lightbox-c2pa");

    if (!lightbox || !closeBtn || !overlay) return;

    let currentImages: HTMLImageElement[] = [];
    let currentIndex = -1;
    let activeImgIndex = 0;
    let isTransitioning = false;

    // Cache metadata by directory to avoid redundant fetches
    const metadataCache = (window.__lightboxMetadataCache ||= new Map());

    const formatDate = (dateStr: string) => {
      if (!dateStr) return '';
      try {
        // Handle old EXIF format: "YYYY:MM:DD HH:MM:SS"
        if (/^\d{4}:\d{2}:\d{2}/.test(dateStr)) {
          const [datePart] = dateStr.split(' ');
          const [year, month, day] = datePart.split(':');
          const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
          return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        }
        // Already human-readable from hosted API (e.g. "Oct 08, 2021 at 09:17 PM")
        const atIndex = dateStr.indexOf(' at ');
        return atIndex !== -1 ? dateStr.substring(0, atIndex) : dateStr;
      } catch {
        return dateStr;
      }
    };

    const formatCameraFull = (make: string, model: string) => {
      if (!model) return make || '';
      if (!make) return model;
      if (model.toUpperCase().includes(make.toUpperCase())) return model;
      return `${make} ${model}`;
    };

    const formatExposure = (time: number) => {
      if (!time) return '';
      if (time >= 1) return `${time}s`;
      return `1/${Math.round(1/time)}s`;
    };

    const formatMeteringMode = (mode: number) => {
      const modes: Record<number, string> = { 0: 'Unknown', 1: 'Average', 2: 'Center-weighted', 3: 'Spot', 4: 'Multi-spot', 5: 'Pattern', 6: 'Partial' };
      return mode !== undefined ? (modes[mode] || `Mode ${mode}`) : '';
    };

    const formatExposureProgram = (program: number) => {
      const programs: Record<number, string> = { 0: 'Not defined', 1: 'Manual', 2: 'Program AE', 3: 'Aperture Priority', 4: 'Shutter Priority', 5: 'Creative', 6: 'Action', 7: 'Portrait', 8: 'Landscape' };
      return program !== undefined ? (programs[program] || '') : '';
    };

    const buildSection = (title: string, rows: Array<{label: string, value: any}>) => {
      const validRows = rows.filter(r => r.value !== '' && r.value !== undefined && r.value !== null);
      if (validRows.length === 0) return '';
      return `
        <div class="info-panel-section">
          <div class="info-panel-section-title">${title}</div>
          <div class="info-panel-details">
            ${validRows.map(r => `<div class="info-panel-row"><span class="info-panel-label">${r.label}</span><span class="info-panel-value">${r.value}</span></div>`).join('')}
          </div>
        </div>
      `;
    };

    const C2PA_API = 'https://apps.thecontrarian.in/c2pa';

    const resolveImageUri = (imgPath: string): string => {
      if (imgPath.startsWith('http://') || imgPath.startsWith('https://')) return imgPath;
      if (imgPath.startsWith('/library/')) {
        return `https://library.thecontrarian.in${imgPath.replace('/library', '')}`;
      }
      return imgPath;
    };

    const normalizeToPathname = (imgUrl: string) => {
      try {
        return new URL(imgUrl, window.location.origin).pathname;
      } catch {
        return imgUrl;
      }
    };

    const getMetadata = async (imgUrl: string) => {
      try {
        // Prefer metadata embedded on the page (e.g. provided by Carousel)
        const globalMap = window.__imageMetadataBySrc;
        if (globalMap) {
          const pathname = normalizeToPathname(imgUrl);
          const direct = globalMap.get(imgUrl) || globalMap.get(pathname);
          if (direct) return direct;
        }

        // Check cache
        const cacheKey = imgUrl;
        if (metadataCache.has(cacheKey)) return metadataCache.get(cacheKey);

        // Call hosted EXIF API
        const uri = resolveImageUri(normalizeToPathname(imgUrl));
        const apiUrl = `${C2PA_API}/api/exif_metadata?uri=${encodeURIComponent(uri)}`;
        const resp = await fetch(apiUrl);
        if (!resp.ok) {
          metadataCache.set(cacheKey, null);
          return null;
        }
        const data = await resp.json();
        // API returns { "filename": { ...metadata } } — extract first value
        const keys = Object.keys(data);
        const meta = keys.length > 0 ? data[keys[0]] : null;
        metadataCache.set(cacheKey, meta);
        return meta;
      } catch {
        return null;
      }
    };

    const updateCaptionAndMeta = async (targetImgEl: HTMLImageElement) => {
      if (!exifContainer) return;

      // Prefer caption from figure/figcaption when present, else alt.
      let capText = "";
      const fig = targetImgEl.closest("figure");
      if (fig) {
        const cap = fig.querySelector("figcaption");
        if (cap) capText = cap.textContent || "";
      }

      exifContainer.innerHTML = '<p class="loading-meta">Fetching metadata...</p>';

      const attachCRButton = (imgSrc: string) => {
        const crBtn = exifContainer.querySelector('.info-panel-cr-button');
        if (crBtn) {
          crBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            openC2PAOverlay(imgSrc);
          });
        }
      };

      // CR Logo SVG - defined once for reuse
      const crLogoSvg = `<svg viewBox="0 0 500 500" fill="none" xmlns="http://www.w3.org/2000/svg" class="cr-logo"><path d="M195.796,356.024c-50.865,0-82.616-39.85-82.616-87.151s31.75-87.151,82.616-87.151c41.145,0,69.008,26.891,76.459,61.88h-41.469c-5.508-15.551-18.467-24.946-34.99-24.946c-25.594,0-42.443,20.086-42.443,50.217c0,30.13,16.848,50.217,42.443,50.217c17.17,0,30.454-10.043,35.637-26.566h41.146C265.775,328.486,237.588,356.024,195.796,356.024z" fill="currentColor"/><path d="M288.962,351.488V186.258h38.878v17.819c9.071-11.987,23.327-19.763,44.71-19.763h10.043v38.229h-10.366c-14.58,0-23.651,3.24-30.455,9.395c-7.775,6.48-12.311,17.172-12.311,33.371v86.179H288.962z" fill="currentColor"/><path d="M475,474.974H249.974C125.923,474.974,25,374.048,25,250C25,125.949,125.93,25.026,249.987,25.026C374.061,25.026,475,125.961,475,250.027V474.974z M249.987,64.024c-102.556,0-185.99,83.43-185.99,185.977c0,102.544,83.43,185.972,185.977,185.972h186.029V250.027C436.003,147.465,352.557,64.024,249.987,64.024z" fill="currentColor"/></svg>`;

      try {
        const meta = await getMetadata(targetImgEl.currentSrc || targetImgEl.src);
        if (!meta) {
          const fallbackTitle = capText || targetImgEl.alt || "";
          exifContainer.innerHTML = `
            <div class="carousel-info-panel">
              <div class="info-panel-header">
                <span class="info-panel-title">Image Info</span>
              </div>
              ${fallbackTitle ? `<p class="info-panel-description"></p>` : ''}
              ${buildSection('File', [
                { label: 'Dimensions', value: `${targetImgEl.naturalWidth} × ${targetImgEl.naturalHeight}` }
              ])}
              <button class="c2pa-indicator info-panel-cr-button" aria-label="View Content Credentials">
                ${crLogoSvg}<span class="c2pa-indicator-label">content credentials</span>
              </button>
            </div>
          `;
          const descEl = exifContainer.querySelector('.info-panel-description');
          if (descEl) descEl.textContent = fallbackTitle;
          attachCRButton(targetImgEl.src);
          return;
        }

        const photo = meta.photography || {};
        const exif = meta.exif || {};
        const description = photo.description || capText || targetImgEl.alt || '';
        const dateFormatted = formatDate(photo.date_original || exif.DateTimeOriginal);
        const timeOriginal = exif.DateTimeOriginal?.split(' ')[1] || '';
        const cameraFull = formatCameraFull(photo.camera_make || '', photo.camera_model || '');

        // Build sections using helper - reorganized for clarity
        const fileSection = buildSection('File', [
          { label: 'Filename', value: meta.filename || '' },
          { label: 'Format', value: meta.format || '' },
          { label: 'Dimensions', value: (meta.width && meta.height) ? `${meta.width} × ${meta.height}` : '' },
        ]);

        const cameraSection = buildSection('Camera', [
          { label: 'Body', value: cameraFull },
          { label: 'Lens', value: photo.lens_model || '' },
        ]);

        // Combine exposure settings into a cleaner format
        const focalLengthVal = photo.focal_length || (exif.FocalLength ? `${exif.FocalLength}mm` : '');
        const focalWith35mm = focalLengthVal && exif.FocalLengthIn35mmFilm ? `${focalLengthVal} (${exif.FocalLengthIn35mmFilm}mm eq.)` : focalLengthVal;
        
        const exposureSection = buildSection('Exposure', [
          { label: 'Focal Length', value: focalWith35mm },
          { label: 'Aperture', value: photo.aperture || (exif.FNumber ? `f/${exif.FNumber}` : '') },
          { label: 'Shutter', value: photo.shutter_speed || formatExposure(exif.ExposureTime) },
          { label: 'ISO', value: photo.iso || exif.ISOSpeedRatings || '' },
          { label: 'Program', value: formatExposureProgram(exif.ExposureProgram) },
          { label: 'Metering', value: formatMeteringMode(exif.MeteringMode) },
        ]);

        const captureSection = buildSection('Capture', [
          { label: 'Date', value: dateFormatted },
          { label: 'Time', value: timeOriginal ? `${timeOriginal}${exif.OffsetTime ? ` (${exif.OffsetTime})` : ''}` : '' },
        ]);

        const processingSection = buildSection('Processing', [
          { label: 'Software', value: exif.Software || '' },
          { label: 'Color Space', value: exif.ColorSpace === 1 ? 'sRGB' : (exif.ColorSpace ? `${exif.ColorSpace}` : '') },
          { label: 'Resolution', value: (exif.XResolution && exif.YResolution) ? `${exif.XResolution} × ${exif.YResolution} ${exif.ResolutionUnit === 2 ? 'DPI' : 'DPCM'}` : '' },
        ]);

        const creditsSection = buildSection('Credits', [
          { label: 'Artist', value: photo.artist || '' },
        ]);
        
        exifContainer.innerHTML = `
          <div class="carousel-info-panel">
            <div class="info-panel-header">
              <span class="info-panel-title">Image Info</span>
            </div>
            ${description ? `<p class="info-panel-description"></p>` : ''}
            ${fileSection}${cameraSection}${exposureSection}${captureSection}${processingSection}${creditsSection}
            <button class="c2pa-indicator info-panel-cr-button" aria-label="View Content Credentials">
              ${crLogoSvg}<span class="c2pa-indicator-label">content credentials</span>
            </button>
          </div>
        `;

        const descEl = exifContainer.querySelector('.info-panel-description');
        if (descEl) descEl.textContent = description;

        attachCRButton(lightboxImages[activeImgIndex]?.src || targetImgEl.src);
      } catch (err) {
        exifContainer.innerHTML = `<p>Metadata unavailable</p>`;
      }
    };

    const updateLightbox = (index: number, withTransition = false) => {
      if (index < 0 || index >= currentImages.length) return;
      const target = currentImages[index];
      const isVertical = target.naturalHeight > target.naturalWidth;
      lightbox.setAttribute("data-orientation", isVertical ? "vertical" : "horizontal");
      const currentImgEl = lightboxImages[activeImgIndex] as HTMLImageElement;

      if (withTransition && !isTransitioning) {
        isTransitioning = true;
        currentImgEl.style.opacity = '0';
        setTimeout(() => {
          currentImgEl.src = target.src;
          currentImgEl.alt = target.alt || "";
          const completeTransition = () => {
            updateCaptionAndMeta(currentImgEl);
            requestAnimationFrame(() => {
              currentImgEl.style.opacity = '1';
              setTimeout(() => { isTransitioning = false; }, 300);
            });
          };
          if (currentImgEl.complete) completeTransition();
          else {
            currentImgEl.onload = completeTransition;
            currentImgEl.onerror = () => { isTransitioning = false; };
          }
        }, 300);
      } else {
        currentImgEl.style.opacity = '0';
        currentImgEl.src = target.src;
        currentImgEl.alt = target.alt || "";
        const showImage = () => {
          updateCaptionAndMeta(currentImgEl);
          currentImgEl.style.opacity = '1';
        };
        if (currentImgEl.complete) requestAnimationFrame(showImage);
        else currentImgEl.onload = showImage;
      }
      currentIndex = index;
    };

    const openLightbox = (imageElement: HTMLImageElement) => {
      const container = document.querySelector(selector);
      if (!container) return;

      if (gallery) {
        let images = Array.from(container.querySelectorAll("img")).filter((i: HTMLImageElement) => {
          if (i.closest("a") || i.classList.contains("no-lightbox")) return false;
          const src = i.currentSrc || i.getAttribute('src') || '';
          if (!src) return false;
          return true;
        });
        
        if (includeHero) {
          const heroImg = document.querySelector(".post-hero img") as HTMLImageElement;
          if (heroImg && !images.includes(heroImg)) {
            images = [heroImg, ...images];
          }
        }
        
        currentImages = images;
        currentIndex = currentImages.indexOf(imageElement);
      } else {
        currentImages = [imageElement];
        currentIndex = 0;
      }

      if (currentIndex === -1) currentIndex = 0;

      lightboxImages.forEach(img => {
        img.classList.remove('active', 'next');
        img.removeAttribute('src');
      });
      activeImgIndex = 0;

      updateLightbox(currentIndex, false);
      lightbox.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
      document.body.classList.add("lightbox-open", "toc-hidden");
      lightbox.classList.add("lights-on");
      lightbox.classList.remove("lights-off");
      if (metaContainer) metaContainer.classList.add("is-active");
      if (toggleLightsBtn) toggleLightsBtn.classList.add("active");
    };

    const closeLightbox = () => {
      lightbox.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
      document.body.classList.remove("lightbox-open", "toc-hidden");
      setTimeout(() => {
        lightboxImages.forEach(img => {
          img.removeAttribute('src');
          img.classList.remove('active', 'next');
        });
        isTransitioning = false;
      }, 300);
    };

    const nextImage = () => {
      if (isTransitioning) return;
      if (currentIndex < currentImages.length - 1) updateLightbox(currentIndex + 1, true);
      else if (currentImages.length > 1) updateLightbox(0, true);
    };

    const prevImage = () => {
      if (isTransitioning) return;
      if (currentIndex > 0) updateLightbox(currentIndex - 1, true);
      else if (currentImages.length > 1) updateLightbox(currentImages.length - 1, true);
    };

    const attachListeners = () => {
      const container = document.querySelector(selector);
      if (!container) return;
      
      const images = container.querySelectorAll("img");
      
      images.forEach((image) => {
        if (image.closest("a") || image.classList.contains("no-lightbox")) return;
        image.style.cursor = "zoom-in";
        
        image.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          openLightbox(image);
        };
      });
      
      if (includeHero) {
        const heroImg = document.querySelector(".post-hero img") as HTMLImageElement;
        if (heroImg && !heroImg.closest("a") && !heroImg.classList.contains("no-lightbox")) {
          heroImg.style.cursor = "zoom-in";
          heroImg.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            openLightbox(heroImg);
          };
        }
      }
    };

    let attachTimer = 0;
    const scheduleAttachListeners = () => {
      if (attachTimer) window.clearTimeout(attachTimer);
      attachTimer = window.setTimeout(() => {
        attachTimer = 0;
        attachListeners();
      }, 50);
    };

    // Expose for subsequent Astro page transitions without re-initializing controls.
    window.__attachLightboxListeners = scheduleAttachListeners;

    // Initialize
    attachListeners();
    
    // Support Astro ViewTransitions
    document.addEventListener("astro:page-load", scheduleAttachListeners);
    document.addEventListener("astro:after-swap", scheduleAttachListeners);
    
    // Fallback for dynamically added content
    const observer = new MutationObserver(scheduleAttachListeners);
    const container = document.querySelector(selector);
    if (container) observer.observe(container, { childList: true, subtree: true });
    closeBtn.addEventListener("click", closeLightbox);
    overlay.addEventListener("click", closeLightbox);
    
    if (gallery && prevBtn && nextBtn) {
      prevBtn.addEventListener("click", (e) => { e.stopPropagation(); prevImage(); });
      nextBtn.addEventListener("click", (e) => { e.stopPropagation(); nextImage(); });
    }

    if (toggleLightsBtn) {
      toggleLightsBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        const isCurrentlyOff = lightbox.classList.contains("lights-off");
        
        if (isCurrentlyOff) {
          // Turn lights ON
          lightbox.classList.remove("lights-off");
          lightbox.classList.add("lights-on");
          toggleLightsBtn.classList.add("active");
        } else {
          // Turn lights OFF
          lightbox.classList.add("lights-off");
          lightbox.classList.remove("lights-on");
          toggleLightsBtn.classList.remove("active");
        }
      });
    }

    if (c2paBtn) {
      c2paBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        const currentImgEl = lightboxImages[activeImgIndex] as HTMLImageElement;
        if (currentImgEl?.src) openC2PAOverlay(currentImgEl.src);
      });
    }

    const mainArea = document.querySelector(".lightbox-main");
    if (mainArea) {
      mainArea.addEventListener("click", (e) => {
        if (e.target === mainArea || e.target === document.querySelector(".lightbox-figure")) closeLightbox();
      });
    }

    document.addEventListener("keydown", (e) => {
      if (lightbox.getAttribute("aria-hidden") === "true") return;
      if (e.key === "Escape") closeLightbox();
      if (gallery) {
        if (e.key === "ArrowRight") nextImage();
        if (e.key === "ArrowLeft") prevImage();
      }
    });

    lightbox.dataset.initialized = 'true';
  }

  initLightbox();
  document.addEventListener("astro:page-load", initLightbox);
</script>
