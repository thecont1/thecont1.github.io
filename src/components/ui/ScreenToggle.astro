---
/**
 * ScreenToggle.astro
 * A reusable component that toggles "Screen Mode" - a focused viewing mode
 * that dims the page and highlights key content like images and titles.
 */
---

<button id="screen-toggle" class="screen-toggle-btn toggle-btn" aria-label="Toggle Screen Mode">
  <span class="dot"></span>
  <span class="label">Screen</span>
</button>

<style is:global>
  /* Shared Toggle Button Styles (copied for independence) */
  .toggle-btn {
    position: fixed;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    background: #1a1f2c;
    border: none;
    width: 2.8rem;
    height: 180px;
    padding: 0;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    font-family: "Inter", sans-serif;
    text-transform: uppercase;
    letter-spacing: 0.25em;
    font-size: 0.75rem !important;
    font-weight: 600;
    color: white !important;
    transition: color 0.3s ease, background-color 0.3s ease;
    border-radius: 0 16px 16px 0;
    pointer-events: auto;
    box-shadow: none;
    z-index: 9500; /* Increased base to stay above curtain (9000) when not explicitly pushed under */
  }

  .toggle-btn:hover,
  .toggle-btn.active {
    color: var(--accent, #d04b36) !important;
  }

  .toggle-btn .label {
    writing-mode: vertical-rl;
    text-orientation: mixed;
    display: block;
    text-align: center;
    margin: 0;
    padding: 0;
    line-height: 1;
  }

  .toggle-btn .dot {
    width: 6px;
    height: 6px;
    background: var(--accent, #d04b36);
    border-radius: 50%;
    transition: opacity 0.3s;
    flex-shrink: 0;
  }

  /* Screen Toggle Specific Position */
  .screen-toggle-btn {
    top: 78% !important;
  }

  /* Mobile: Position Screen tab hanging from left side of menubar, next to Contents */
  @media (max-width: 768px) {
    .screen-toggle-btn {
      display: none !important;
    }

    :root {
      --mobile-left-tabs-inset: 0px;
      --mobile-screen-tab-width: 113px;
      --mobile-tabs-gap: 8px;
    }

    .screen-toggle-btn {
      position: fixed !important;
      top: calc(var(--site-header-height, 64px) + 0.5rem) !important; /* Keep aligned with Contents tab */
      left: calc(var(--mobile-left-tabs-inset, 0px) + var(--mobile-screen-tab-width, 113px) + var(--mobile-tabs-gap, 8px)) !important; /* Immediately right of Contents */
      right: auto !important;
      transform: none !important;
      width: auto !important; /* Auto width for horizontal layout */
      height: 2.5rem !important; /* Horizontal height */
      background: #1a1f2c !important;
      border-radius: 0 0 8px 8px !important; /* Rounded bottom corners only */
      z-index: 30000003 !important; /* Higher than mobile nav and sidebar */
      flex-direction: row !important; /* Horizontal layout */
      gap: 0.5rem !important;
      padding: 0.5rem 1rem !important; /* Horizontal padding */
      min-width: var(--mobile-screen-tab-width) !important; /* Minimum width */
    }

    .screen-toggle-btn .label {
      writing-mode: initial !important; /* Horizontal text */
      text-orientation: initial !important;
      font-size: 0.75rem !important;
      font-weight: 600 !important;
      text-transform: uppercase !important;
      letter-spacing: 0.1em !important;
    }

    .screen-toggle-btn .dot {
      width: 4px !important;
      height: 4px !important;
    }
  }

  .screen-toggle-btn .dot {
    opacity: 0.5;
  }

  .screen-toggle-btn:hover .dot,
  .screen-toggle-btn.active .dot {
    opacity: 1;
  }

  /* Screen Mode - The Magic Curtain */
  body::after {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    height: 100%;
    width: 100%;
    background: rgba(255, 255, 255, 0.85); /* Milky translucent */
    backdrop-filter: blur(12px);
    z-index: 9000;
    transform: translate3d(-100%, 0, 0);
    transition: transform 0.8s cubic-bezier(0.77, 0, 0.175, 1);
    pointer-events: none;
    will-change: transform;
    box-shadow: none;
  }

  body.screen-mode::after {
    transform: translate3d(0, 0, 0);
    pointer-events: auto;
  }

  /* Ensure sidebar transitions smoothly behind the curtain */
  .post-sidebar {
    transition: transform 0.5s cubic-bezier(0.77, 0, 0.175, 1), opacity 0.5s ease !important;
  }

  /* Lifting elements above the curtain */
  body.screen-mode .editorial-post,
  body.screen-mode .simple-post,
  body.screen-mode .longform-post,
  body.screen-mode .project-layout,
  body.screen-mode .datastory-layout,
  body.screen-mode .photo-album-layout,
  body.screen-mode .code-layout,
  body.screen-mode .thread-layout,
  body.screen-mode .timeline-layout,
  body.screen-mode .post-layout-container,
  body.screen-mode .longform-layout-container,
  body.screen-mode .post-header,
  body.screen-mode .post-body,
  body.screen-mode .site-footer,
  body.screen-mode-exiting .editorial-post,
  body.screen-mode-exiting .simple-post,
  body.screen-mode-exiting .longform-post,
  body.screen-mode-exiting .project-layout,
  body.screen-mode-exiting .datastory-layout,
  body.screen-mode-exiting .photo-album-layout,
  body.screen-mode-exiting .code-layout,
  body.screen-mode-exiting .thread-layout,
  body.screen-mode-exiting .timeline-layout,
  body.screen-mode-exiting .post-layout-container,
  body.screen-mode-exiting .longform-layout-container,
  body.screen-mode-exiting .post-header,
  body.screen-mode-exiting .post-body,
  body.screen-mode-exiting .site-footer {
    z-index: auto !important;
  }

  body.screen-mode h1,
  body.screen-mode figure,
  body.screen-mode img,
  body.screen-mode figcaption,
  body.screen-mode .post-meta-top,
  body.screen-mode .meta-top,
  body.screen-mode .meta,
  body.screen-mode .post-title,
  body.screen-mode .post-subtitle,
  body.screen-mode .post-date-line,
  body.screen-mode .post-kicker,
  body.screen-mode .thread-title,
  body.screen-mode .post-lead,
  body.screen-mode .lead,
  body.screen-mode .summary,
  body.screen-mode .thread-subtitle,
  body.screen-mode .instruction,
  body.screen-mode .post-author-line,
  body.screen-mode .author-name,
  body.screen-mode .engine,
  body.screen-mode .site-footer,
  body.screen-mode-exiting h1,
  body.screen-mode-exiting figure,
  body.screen-mode-exiting img,
  body.screen-mode-exiting figcaption,
  body.screen-mode-exiting .post-meta-top,
  body.screen-mode-exiting .meta-top,
  body.screen-mode-exiting .meta,
  body.screen-mode-exiting .post-title,
  body.screen-mode-exiting .post-subtitle,
  body.screen-mode-exiting .post-date-line,
  body.screen-mode-exiting .post-kicker,
  body.screen-mode-exiting .thread-title,
  body.screen-mode-exiting .post-lead,
  body.screen-mode-exiting .lead,
  body.screen-mode-exiting .summary,
  body.screen-mode-exiting .thread-subtitle,
  body.screen-mode-exiting .instruction,
  body.screen-mode-exiting .post-author-line,
  body.screen-mode-exiting .author-name,
  body.screen-mode-exiting .engine,
  body.screen-mode-exiting .site-footer {
    position: relative;
    z-index: 9001 !important;
    transition: transform 0.6s ease;
  }

  body.screen-mode figure {
    transform: scale(1.05); /* Reduced scaling to prevent bleeding */
    max-width: 95vw; /* Prevent horizontal overflow */
    overflow: hidden;
    margin: 0 auto; /* Center the figure */
  }

  body.screen-mode figure img {
    max-width: 100%;
    width: auto;
    height: auto;
    object-fit: contain;
    display: block;
    margin: 0 auto; /* Center the image within figure */
  }

  /* Handle standalone images (not in figures) */
  body.screen-mode img:not(figure img) {
    transform: scale(1.05);
    max-width: 95vw;
    margin: 0 auto;
    display: block;
  }

  /* Keep Screen toggle ALWAYS on top to prevent vanishing during transitions */
  .screen-toggle-btn {
    z-index: 11000 !important;
  }

  /* Handle TOC tab and Sidebar layering during Screen Mode */
  body.screen-mode .toc-toggle-btn,
  body.screen-mode .post-sidebar,
  body.screen-mode-exiting .toc-toggle-btn,
  body.screen-mode-exiting .post-sidebar {
    z-index: 8000 !important; /* Slide UNDER the curtain (9000) */
    opacity: 1 !important;
    visibility: visible !important;
    pointer-events: auto;
  }

  /* Transition for liftable elements */
  figure,
  img,
  figcaption,
  .post-meta-top,
  .post-title,
  .thread-title,
  .post-lead,
  .lead,
  .summary,
  .thread-subtitle,
  .instruction,
  .post-author-line,
  .author-name,
  h1 {
    transition: transform 0.6s ease;
  }
</style>

<script>
  function initScreenMode() {
    const screenToggle = document.getElementById('screen-toggle');
    if (!screenToggle || screenToggle.dataset.hasScreenListener) return;

    screenToggle.addEventListener('click', () => {
      const isScreenMode = document.body.classList.contains('screen-mode');
      
      if (isScreenMode) {
        // Turning OFF
        document.body.classList.add('screen-mode-exiting');
        document.body.classList.remove('screen-mode');
        screenToggle.classList.remove('active');
        
        setTimeout(() => {
          document.body.classList.remove('screen-mode-exiting');
        }, 1000);
      } else {
        // Turning ON
        document.body.classList.add('screen-mode');
        screenToggle.classList.add('active');
      }
    });
    
    screenToggle.dataset.hasScreenListener = 'true';
  }

  // Initialize on load
  initScreenMode();

  // Re-initialize on Astro page navigation
  document.addEventListener('astro:page-load', initScreenMode);
</script>
