---
/**
 * C2PAOverlay.astro
 * An overlay screen that displays C2PA Content Credentials for an image.
 */
import IconCR from "../icons/IconCR.astro";
import "../../styles/c2pa.css";
import { CLOSE_SVG } from "../icons/cr-logo-svg";
---

<div id="c2pa-overlay" class="c2pa-overlay" aria-hidden="true">
  <div class="c2pa-overlay-backdrop"></div>
  
  <div class="c2pa-container">
    <header class="c2pa-header">
      <div class="c2pa-title-group">
        <IconCR class="c2pa-icon" width="32" height="32" />
        <h2>Content Credentials</h2>
      </div>
      <button id="c2pa-close" class="c2pa-close-btn" aria-label="Close credentials" set:html={CLOSE_SVG}>
      </button>
    </header>

    <div id="c2pa-content" class="c2pa-content">
      <div class="c2pa-loading">Loading credentials...</div>
    </div>

    <footer class="c2pa-footer">
      <p>Content Credentials provide verifiable information about an image's origin and history. <a href="https://contentauthenticity.org" target="_blank" rel="noopener">Learn more</a></p>
    </footer>
  </div>
</div>

<script>
  import "../../styles/c2pa.css";
  import { CR_LOGO_SVG, SHIELD_CHECK_SVG, SHIELD_X_SVG } from "../icons/cr-logo-svg";
  import { fetchC2PAMini, fetchC2PAData } from "../../utils/c2pa.js";

  class C2PAManager {
    overlay: HTMLElement | null;
    content: HTMLElement | null;
    closeBtn: HTMLElement | null;
    backdrop: HTMLElement | null;

    constructor() {
      this.overlay = document.getElementById('c2pa-overlay');
      this.content = document.getElementById('c2pa-content');
      this.closeBtn = document.getElementById('c2pa-close');
      this.backdrop = document.querySelector('.c2pa-overlay-backdrop');
      
      this.init();
      this.injectIndicators();
    }

    init() {
      if (!this.overlay) return;

      this.closeBtn?.addEventListener('click', () => this.close());
      this.backdrop?.addEventListener('click', () => this.close());

      // Expose manager on overlay element for direct access
      if (this.overlay) {
        (this.overlay as any)._manager = this;
      }

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && this.overlay?.classList.contains('is-active')) {
          this.close();
        }
      });
    }

    // Cache for c2pa_mini results per image URI
    miniCache = new Map<string, any>();

    async fetchMini(imgSrc: string): Promise<any> {
      const pathname = (() => {
        try { return new URL(imgSrc, window.location.origin).pathname; } catch { return imgSrc; }
      })();
      if (this.miniCache.has(pathname)) return this.miniCache.get(pathname);

      try {
        const data = await fetchC2PAMini(pathname);
        this.miniCache.set(pathname, data);
        return data;
      } catch {
        this.miniCache.set(pathname, null);
        return null;
      }
    }

    // Build the mini popup HTML from c2pa_mini response
    buildMiniPopup(data: any, imgSrc: string): string {
      if (!data || data.error || data.status === 'unverified') {
        return `
          <div class="c2pa-mini-popup">
            <div class="c2pa-mini-status c2pa-mini-unverified">
              ${SHIELD_X_SVG}
              <span>Unavailable</span>
            </div>
          </div>
        `;
      }
      const rows = [
        data.creator ? `<div class="c2pa-mini-row"><span class="c2pa-mini-label">Creator</span><span class="c2pa-mini-value">${data.creator}</span></div>` : '',
        data.issued_by ? `<div class="c2pa-mini-row"><span class="c2pa-mini-label">Signed by</span><span class="c2pa-mini-value">${data.issued_by}</span></div>` : '',
        data.issued_on ? `<div class="c2pa-mini-row"><span class="c2pa-mini-label">Date</span><span class="c2pa-mini-value">${data.issued_on}</span></div>` : '',
        data.digital_source_type ? `<div class="c2pa-mini-row"><span class="c2pa-mini-label">Source</span><span class="c2pa-mini-value">${data.digital_source_type}</span></div>` : '',
      ].filter(Boolean).join('');

      return `
        <div class="c2pa-mini-popup">
          <div class="c2pa-mini-status c2pa-mini-verified">
            ${SHIELD_CHECK_SVG}
            <span>${data.status || 'Verified'}</span>
          </div>
          <div class="c2pa-mini-details">${rows}</div>
          <a class="c2pa-mini-more" data-c2pa-detail="true" href="#">View full credentials</a>
        </div>
      `;
    }

    // Automatically find /library/ images and add CR indicators with mini popup.
    // Deferred to run after layout scripts (Post/Essay) finish wrapping images in figures.
    injectIndicators() {
      // Prevent multiple injections
      if ((window as any).__c2paInjecting) {
        return;
      }
      
      (window as any).__c2paInjecting = true;
      
      // Use a small delay so Post/Essay layout scripts finish their figure-wrapping first
      setTimeout(() => {
        this._doInject();
        (window as any).__c2paInjecting = false;
      }, 120);
    }

    private _doInject() {
      const selectors = [
        '.post-body img',
        '.post-hero img',
        '.album-item img',
        '.notebook-wrapper img',
        '.project-layout img',
        '.datastory-layout img',
        '.code-layout img',
        '.thread-layout img',
        '.timeline-layout img',
        '.photogallery-oneup .gallery-item img',
        '.photogallery-grid .gallery-item img'
      ];

      const contentImages = document.querySelectorAll(selectors.join(', '));
      // Deduplicate (same img can match multiple selectors)
      const seen = new Set<HTMLImageElement>();

      contentImages.forEach(img => {
        const imgEl = img as HTMLImageElement;
        if (seen.has(imgEl)) return;
        seen.add(imgEl);

        const attach = () => {
          const src = imgEl.getAttribute('src');
          if (!src || !src.includes('/library/')) {
            return;
          }

          // Skip inside lightbox (it has its own CR button)
          if (imgEl.closest('#lightbox') || imgEl.closest('.lightbox-figure')) {
            return;
          }

          // Find the positioning container — prefer figure, then album/gallery item
          let container: HTMLElement | null =
            imgEl.closest('figure') as HTMLElement ||
            imgEl.closest('.album-item') as HTMLElement ||
            imgEl.closest('.gallery-item') as HTMLElement;

          // Fallback: use the image's direct parent
          if (!container) {
            container = imgEl.parentElement;
          }

          if (!container) return;

          // Already has an indicator? Skip.
          if (container.querySelector('.c2pa-indicator.c2pa-injected')) {
            return;
          }

          // Check if image is already wrapped
          if (imgEl.closest('.c2pa-image-wrapper')) {
            return;
          }

          // Create a wrapper that exactly matches the image dimensions
          const wrapper = document.createElement('div');
          wrapper.className = 'c2pa-image-wrapper';
          wrapper.style.position = 'relative';
          wrapper.style.display = 'inline-block'; // Match image display

          // Wrap the image
          if (imgEl.parentNode) {
            imgEl.parentNode.insertBefore(wrapper, imgEl);
            wrapper.appendChild(imgEl);
          } else {
            return;
          }

          // Create the CR logo button
          const btn = document.createElement('button');
          btn.className = 'c2pa-indicator c2pa-injected';
          btn.setAttribute('aria-label', 'View Content Credentials');
          btn.innerHTML = CR_LOGO_SVG;

          // Create the mini popup container (hidden by default)
          const popup = document.createElement('div');
          popup.className = 'c2pa-mini-popup-wrap';
          popup.style.display = 'none';

          let hideTimer: ReturnType<typeof setTimeout> | null = null;
          let fetched = false;

          const positionPopup = () => {
            // Default: right side of image via CSS transform
            popup.style.right = '0';
            popup.style.left = '';
            popup.style.transform = 'translateX(calc(100% + 8px))';

            // Check if it overflows the viewport
            requestAnimationFrame(() => {
              const rect = popup.getBoundingClientRect();
              if (rect.right > window.innerWidth - 8) {
                // Flip to left side of the container
                popup.style.right = '';
                popup.style.left = '0';
                popup.style.transform = 'translateX(calc(-100% - 8px))';
              }
            });
          };

          const showPopup = async () => {
            if (hideTimer) { clearTimeout(hideTimer); hideTimer = null; }
            popup.style.display = 'block';

            if (!fetched) {
              popup.innerHTML = '<div class="c2pa-mini-popup"><div class="c2pa-mini-loading">Checking...</div></div>';
              positionPopup();
              const data = await this.fetchMini(src);
              popup.innerHTML = this.buildMiniPopup(data, src);
              fetched = true;
              positionPopup();

              // Wire the "View full credentials" link
              const moreLink = popup.querySelector('[data-c2pa-detail]');
              if (moreLink) {
                moreLink.addEventListener('click', (e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  popup.style.display = 'none';
                  this.open(src);
                });
              }
            } else {
              positionPopup();
            }
          };

          const scheduleHide = () => {
            if (hideTimer) clearTimeout(hideTimer);
            hideTimer = setTimeout(() => { popup.style.display = 'none'; }, 200);
          };

          const cancelHide = () => {
            if (hideTimer) { clearTimeout(hideTimer); hideTimer = null; }
          };

          // Hover on CR logo → show popup
          btn.addEventListener('mouseenter', showPopup);
          btn.addEventListener('mouseleave', scheduleHide);
          popup.addEventListener('mouseenter', cancelHide);
          popup.addEventListener('mouseleave', scheduleHide);

          // Click CR logo → open full overlay directly
          const imageSrc = src; // Capture src in closure
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            popup.style.display = 'none';
            this.open(imageSrc);
          });

          wrapper.appendChild(btn);
          wrapper.appendChild(popup);
        };

        if (imgEl.complete) {
          attach();
        } else {
          imgEl.addEventListener('load', attach, { once: true });
        }
      });
    }

    async open(imgSrc: string) {
      const startTime = Date.now();
      this.overlay?.classList.add('is-active');
      document.body.style.overflow = 'hidden';
      
      if (this.content) {
        this.content.innerHTML = '<div class="c2pa-loading">Verifying credentials. Please wait...</div>';
      }

      try {
        const data = await fetchC2PAData(imgSrc);

        // Ensure minimum 1.0s loading delay
        const elapsed = Date.now() - startTime;
        if (elapsed < 1000) {
          await new Promise(resolve => setTimeout(resolve, 1000 - elapsed));
        }

        this.render(data, imgSrc);
      } catch (err: any) {
        // Handle case where API returns no credentials found
        const msg = String(err?.message || '');
        if (msg.includes('No Credentials Found') || msg.includes('no_c2pa') || msg.includes('No credentials found')) {
          if (this.content) {
            this.content.innerHTML = `
              <div class="c2pa-no-results">
                <div class="c2pa-no-results-watermark">
                  ${CR_LOGO_SVG}
                </div>
                
                <div class="c2pa-status c2pa-status-missing">
                  ${SHIELD_X_SVG}
                  Unavailable
                </div>

                <p class="c2pa-message">Content Credentials are not available for this image.</p>
                
                <div class="c2pa-info-box">
                  <p><strong>What are Content Credentials?</strong></p>
                  <p>Content Credentials are cryptographically signed metadata that verify an image's creator and history. Many images don't include them yet, or they may have been removed during editing, compression, or format conversion.</p>
                </div>
              </div>
            `;
          }
          return;
        }

        // Handle other errors
        if (this.content) {
          this.content.innerHTML = `
            <div class="c2pa-error">
              <h3 class="c2pa-error-title">Live Extraction Failed</h3>
              <p class="c2pa-error-message">${err.message}</p>
              <div class="c2pa-debug-info">
                <strong>Debug Info:</strong><br/>
                Requested Path: ${imgSrc}<br/>
                Status: ${err.status || 'Error'}
              </div>
              <button onclick="location.reload()" class="c2pa-retry-btn">Retry</button>
            </div>
          `;
        }
      }
    }

    close() {
      this.overlay?.classList.remove('is-active');
      document.body.style.overflow = '';
    }

    render(data: any, currentImgSrc: string) {
      if (!this.content) return;

      // Check if this is actually valid credential data
      const c2pa = data.c2pa_data || data;
      if (!data || !data.provenance) {
        this.content.innerHTML = `
          <div class="c2pa-no-results">
            <div class="c2pa-no-results-watermark">
              ${CR_LOGO_SVG}
            </div>
            
            <div class="c2pa-status c2pa-status-missing">
              ${SHIELD_X_SVG}
              Unavailable
            </div>

            <p class="c2pa-message">Content Credentials are not available for this image.</p>
            
            <div class="c2pa-info-box">
              <p><strong>What does this mean?</strong></p>
              <p>This image does not contain Content Credentials, which are cryptographically signed metadata that verify an image's creator and history. Without these credentials, you cannot independently verify who created this image or whether it has been altered since creation.</p>
              <p>Many images don't include Content Credentials yet, or they may have been removed during editing, compression, or format conversion.</p>
            </div>
          </div>
        `;
        return;
      }

      const thumbnails = data.thumbnails || {};

      // Extract authors from author_info (hosted API shape)
      let authors: any[] = [];
      const authorInfo = c2pa.author_info || data.author_info || {};
      if (authorInfo.author) {
        authors = Array.isArray(authorInfo.author) ? authorInfo.author : [authorInfo.author];
      }

      // Extract actions from c2pa_data.actions (hosted API shape)
      const actions: any[] = c2pa.actions || [];

      // Format actions for display
      const formattedActions = actions.map((a: any) => {
        const type = a.action || '';
        const params = a.parameters || {};
        if (type === "c2pa.color_adjustments") {
          return params["com.adobe.acr"] || "Color Adjustments";
        }
        if (type === "c2pa.edited") {
          return params["com.adobe.acr"] || "Edited";
        }
        return type.replace("c2pa.", "").replace(/_/g, " ").replace(/\b\w/g, (l: string) => l.toUpperCase());
      });

      // Filter unique actions
      const uniqueActions = Array.from(new Set(formattedActions));

      // Ingredient info
      const ingredients = c2pa.ingredients || [];
      const ingredient = ingredients[0] || {};
      
      // Signature info
      const signature = c2pa.signature_info || {};
      const dateStr = signature.time ? new Date(signature.time).toLocaleDateString(undefined, { 
        year: 'numeric', month: 'long', day: 'numeric' 
      }) : null;

      // Basic info
      const basicInfo = c2pa.basic_info || {};

      // Digital source type
      const sourceType = data.digital_source_type || c2pa.digital_source_type || {};

      this.content.innerHTML = `
        <div class="c2pa-verified-results">
          <div class="c2pa-no-results-watermark">
            ${CR_LOGO_SVG}
          </div>

          <div class="c2pa-section c2pa-status-section">
            <div class="c2pa-status">
              ${SHIELD_CHECK_SVG}
              Verified
            </div>
            <p class="c2pa-trust-message">This image has verifiable Content Credentials that confirm its creator and history.</p>
          </div>

          <div class="c2pa-info-grid">
            <div class="c2pa-section">
              <h3 class="c2pa-section-title">Creator</h3>
              <div class="c2pa-info-item">
                <p>${authors[0]?.name || 'Unknown'}</p>
              </div>
              ${authors.slice(1).filter((a: any) => a['@id']).map((a: any) => `
                <div class="c2pa-info-item" style="margin-top: 0.5rem">
                  <p><a href="${a['@id']}" target="_blank" class="c2pa-author-link">${a.name || a['@id']}</a></p>
                </div>
              `).join('')}
            </div>

            <div class="c2pa-section">
              <h3 class="c2pa-section-title">Signed By</h3>
              <div class="c2pa-info-item">
                <p>${signature.issuer || '—'}</p>
                ${dateStr ? `<span class="c2pa-date-badge">${dateStr}</span>` : ''}
              </div>
            </div>

            ${sourceType.label ? `
            <div class="c2pa-section">
              <h3 class="c2pa-section-title">Source</h3>
              <div class="c2pa-info-item">
                <p>${sourceType.label}</p>
              </div>
            </div>
            ` : ''}
          </div>

          <div class="c2pa-section">
            <h3 class="c2pa-section-title">Provenance Comparison</h3>
            <div class="c2pa-image-comparison">
              <div class="c2pa-image-card">
                <div class="c2pa-thumb-wrapper">
                  ${thumbnails.ingredient_thumbnail ? `<img src="data:image/jpeg;base64,${thumbnails.ingredient_thumbnail}" alt="Original image" />` : '<div class="c2pa-no-thumb">No original thumbnail available</div>'}
                </div>
                <div class="c2pa-card-meta">
                  <span class="c2pa-card-badge">Original</span>
                  <p class="c2pa-card-title">${ingredient.title || 'Source File'}</p>
                </div>
              </div>
              <div class="c2pa-image-card">
                <div class="c2pa-thumb-wrapper">
                  ${thumbnails.claim_thumbnail ? `<img src="data:image/jpeg;base64,${thumbnails.claim_thumbnail}" alt="Current image" />` : `<img src="${currentImgSrc}" alt="Current image" />`}
                </div>
                <div class="c2pa-card-meta">
                  <span class="c2pa-card-badge c2pa-card-badge-current">This Image</span>
                  <p class="c2pa-card-title">${basicInfo.title || 'Exported Version'}</p>
                </div>
              </div>
            </div>
          </div>

          <div class="c2pa-section">
            <h3 class="c2pa-section-title">Process & History</h3>
            <div class="c2pa-actions-list">
              ${uniqueActions.map(action => `<span class="c2pa-action-pill">${action}</span>`).join('')}
              ${uniqueActions.length === 0 ? '<p class="c2pa-no-edits">No editing history recorded.</p>' : ''}
            </div>
          </div>
        </div>
      `;
    }
  }

  // Initialize on page load
  function initC2PA() {
    if ((window as any).__c2paManagerInitialized) return;
    (window as any).__c2paManagerInitialized = true;

    const manager = new C2PAManager();
    // Run injection again on any DOM changes to catch late-loading images
    const observer = new MutationObserver(() => {
      manager.injectIndicators();
    });
    observer.observe(document.body, { childList: true, subtree: true });
  }

  initC2PA();
  document.addEventListener('astro:page-load', initC2PA);
</script>
