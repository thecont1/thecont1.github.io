---
/**
 * ContentsToggle.astro
 * A reusable component that provides a slide-out sidebar (Table of Contents, Chapters, etc.).
 */
interface Props {
  title: string;
  label?: string; // The text on the vertical toggle tab (e.g., "Contents", "Chapters")
}

const { title, label = "Contents" } = Astro.props;
---

<aside class="post-sidebar" id="toc-sidebar">
  <nav class="sticky-toc">
    <div class="toc-header">
      <a href="#top" class="toc-title-link">
        <span class="toc-title">{title}</span>
      </a>
    </div>
    <slot />
  </nav>
</aside>

<div id="toc-overlay" class="toc-overlay" aria-hidden="true"></div>

<button id="toc-toggle" class="toc-toggle-btn toggle-btn" aria-label={`Toggle ${label}`}>
  <span class="dot"></span>
  <span class="label">{label}</span>
</button>

<style is:global>
  /* Sidebar Design - Dark Theme Left Drawer */
  .post-sidebar {
    position: fixed;
    left: 0;
    top: 0;
    height: 100vh;
    width: 18vw;
    min-width: 250px;
    background: #1a1f2c;
    color: white;
    z-index: 1000; /* High z-index to ensure visibility above content */
    transition: transform 0.5s cubic-bezier(0.77, 0, 0.175, 1);
    box-shadow: none;
    padding: 6rem 2rem 10rem 4rem; /* Bottom padding for content safety */
    display: flex;
    flex-direction: column;
    visibility: visible;
    pointer-events: auto;
    overflow-y: auto;
  }

  @media (max-width: 768px) {
    .post-sidebar {
      left: 0;
      top: auto;
      bottom: 0;
      width: 100vw;
      min-width: auto;
      height: min(70vh, 560px);
      padding: 1.25rem 1.25rem 2rem;
      z-index: 30000004; /* Above overlay and mobile nav */
      border-top-left-radius: 16px;
      border-top-right-radius: 16px;
      box-shadow: 0 -12px 40px rgba(0, 0, 0, 0.35);
    }
  }

  .post-sidebar:not(.is-open) {
    transform: translateX(-100%);
  }

  @media (max-width: 768px) {
    .post-sidebar:not(.is-open) {
      transform: translateY(110%);
    }
  }

  .toc-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.35);
    z-index: 30000003;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
  }

  @media (max-width: 768px) {
    body.toc-open .toc-overlay {
      opacity: 1;
      pointer-events: auto;
    }
  }

  body.lightbox-open .toc-toggle-btn {
    display: none !important;
  }

  /* Shared Toggle Button Styles (ensuring availability) */
  .toggle-btn {
    position: fixed;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    background: #1a1f2c;
    border: none;
    width: 2.8rem;
    height: 180px;
    padding: 0;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    font-family: "Inter", sans-serif;
    text-transform: uppercase;
    letter-spacing: 0.25em;
    font-size: 0.75rem !important;
    font-weight: 600;
    color: white !important;
    transition: color 0.3s ease, background-color 0.3s ease;
    border-radius: 0 16px 16px 0;
    pointer-events: auto;
    box-shadow: none;
    z-index: 1100; /* High z-index to ensure visibility */
  }

  .toggle-btn:hover,
  .toggle-btn.active {
    color: var(--accent, #d04b36) !important;
  }

  .toggle-btn .label {
    writing-mode: vertical-rl;
    text-orientation: mixed;
    display: block;
    text-align: center;
    margin: 0;
    padding: 0;
    line-height: 1;
  }

  .toggle-btn .dot {
    width: 6px;
    height: 6px;
    background: var(--accent, #d04b36);
    border-radius: 50%;
    transition: opacity 0.3s;
    flex-shrink: 0;
  }

  /* Vertical Position for Contents Tab */
  .toc-toggle-btn {
    top: 61% !important;
  }

  /* Mobile: Position Contents tab hanging from left side of menubar */
  @media (max-width: 768px) {
    :root {
      --mobile-left-tabs-inset: 0px;
      --mobile-contents-tab-width: 113px;
      --mobile-tabs-gap: 8px;
    }

    .toc-toggle-btn {
      position: fixed !important;
      left: 50% !important;
      right: auto !important;
      bottom: max(0px, env(safe-area-inset-bottom, 0px)) !important;
      top: auto !important;
      transform: translateX(-50%) !important;
      width: auto !important; /* Auto width for horizontal layout */
      height: 2.5rem !important; /* Horizontal height */
      background: #1a1f2c !important;
      border-radius: 10px 10px 0 0 !important;
      z-index: 30000005 !important; /* Above sheet */
      flex-direction: row !important; /* Horizontal layout */
      gap: 0.5rem !important;
      padding: 0.5rem 1rem !important; /* Horizontal padding */
      min-width: var(--mobile-contents-tab-width) !important;
    }

    .toc-toggle-btn .label {
      writing-mode: initial !important; /* Horizontal text */
      text-orientation: initial !important;
      font-size: 0.75rem !important;
      font-weight: 600 !important;
      text-transform: uppercase !important;
      letter-spacing: 0.1em !important;
    }

    .toc-toggle-btn .dot {
      width: 4px !important;
      height: 4px !important;
    }
    
    /* Ensure Contents tab is always visible above mobile nav overlay */
    .toc-toggle-btn {
      pointer-events: auto !important;
    }
  }

  .toc-toggle-btn .dot {
    opacity: 0.5;
  }

  .toc-toggle-btn:hover .dot,
  .toc-toggle-btn.active .dot {
    opacity: 1;
  }

  .toc-title {
    font-family: "Fraunces", serif !important;
    font-size: 1.5rem !important;
    font-weight: 300 !important;
    color: white !important;
    margin-bottom: 2.5rem !important;
    line-height: 1.1 !important;
    display: block !important;
    text-transform: none !important;
    letter-spacing: normal !important;
    transition: color 0.2s ease !important;
    transform: none !important;
  }

  .toc-title-link {
    text-decoration: none !important;
    display: block;
    width: 100%;
    cursor: pointer !important;
    pointer-events: auto !important;
  }

  .toc-title-link:hover .toc-title,
  .toc-header:hover .toc-title {
    color: #d04b36 !important;
    opacity: 1 !important;
    transform: none !important;
    transition: color 0.2s ease !important;
  }

  .toc-title-link:hover {
    background: none !important;
    text-decoration: none !important;
    opacity: 1 !important;
  }

  .sticky-toc {
    background: transparent;
    padding: 0;
    height: auto;
    width: 100%;
    box-shadow: none;
    border: none;
  }

  /* TOC Styling */
  .sticky-toc ul {
    list-style: none;
    padding: 0;
    margin: 0;
    counter-reset: chapter;
  }

  .sticky-toc li {
    margin-bottom: 1.25rem;
    counter-increment: chapter;
    display: block;
    position: relative;
  }

  .sticky-toc li::before {
    content: none !important;
    display: none !important;
  }

  .sticky-toc ul a {
    text-decoration: none !important;
    color: white !important;
    font-family: "Fraunces", serif;
    font-size: 1.05rem;
    line-height: 1.3;
    display: block;
    font-weight: 400;
    position: relative;
    pointer-events: auto !important;
  }

  .sticky-toc ul a::before {
    content: counter(chapter) ". ";
    font-family: "Inter", sans-serif;
    font-size: 0.8rem;
    font-weight: 600;
    color: #d04b36;
    margin-right: 0.5rem;
    display: inline-block;
    vertical-align: middle;
  }

  /* Force TOC Hover Colors and Disable Animations */
  .sticky-toc a:hover,
  .sticky-toc li:hover a,
  .sticky-toc a:hover::before,
  .toc-title-link:hover .toc-title,
  .toc-header:hover .toc-title {
    color: #d04b36 !important;
    opacity: 1 !important;
    transform: none !important;
    transition: color 0.2s ease !important;
    animation: none !important;
  }

  .sticky-toc li:hover,
  .toc-title-link:hover {
    transform: none !important;
    background: none !important;
  }
</style>

<script>
  function initContentsToggle() {
    const sidebar = document.getElementById('toc-sidebar');
    const toggle = document.getElementById('toc-toggle');
    const tocTitleLink = document.querySelector('.toc-title-link') as HTMLElement;
    const overlay = document.getElementById('toc-overlay');

    document.body.classList.remove('toc-open');

    if (sidebar && toggle && !toggle.dataset.hasTocListener) {
      toggle.addEventListener('click', () => {
        const isOpen = sidebar.classList.toggle('is-open');
        toggle.classList.toggle('active', isOpen);
        document.body.classList.toggle('toc-open', isOpen);
      });
      toggle.dataset.hasTocListener = 'true';
    }

    if (sidebar && toggle && overlay && !overlay.dataset.hasTocOverlayListener) {
      overlay.addEventListener('click', () => {
        sidebar.classList.remove('is-open');
        toggle.classList.remove('active');
        document.body.classList.remove('toc-open');
      });
      overlay.dataset.hasTocOverlayListener = 'true';
    }

    if (sidebar && toggle && !document.body.dataset.hasTocEscapeListener) {
      document.addEventListener('keydown', (e) => {
        if (e.key !== 'Escape') return;
        if (sidebar.classList.contains('is-open')) {
          sidebar.classList.remove('is-open');
          toggle.classList.remove('active');
          document.body.classList.remove('toc-open');
        }
      });
      document.body.dataset.hasTocEscapeListener = 'true';
    }

    if (tocTitleLink && !tocTitleLink.dataset.hasTitleListener) {
      tocTitleLink.addEventListener('click', (e) => {
        e.preventDefault();
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
        history.pushState(null, '', '#top');
        // Close sidebar on title click
        if (sidebar) {
          sidebar.classList.remove('is-open');
          if (toggle) toggle.classList.remove('active');
          document.body.classList.remove('toc-open');
        }
      });
      tocTitleLink.dataset.hasTitleListener = 'true';
    }

    // Auto-retract: Close Contents panel when clicking any TOC link
    if (sidebar && !sidebar.dataset.hasAutoRetract) {
      const tocLinks = sidebar.querySelectorAll('.sticky-toc a');
      tocLinks.forEach(link => {
        link.addEventListener('click', () => {
          // Close the sidebar after a short delay to allow navigation
          setTimeout(() => {
            sidebar.classList.remove('is-open');
            if (toggle) toggle.classList.remove('active');
            document.body.classList.remove('toc-open');
          }, 150);
        });
      });
      sidebar.dataset.hasAutoRetract = 'true';
    }
  }

  // Initialize on load
  initContentsToggle();

  // Re-initialize on Astro page navigation
  document.addEventListener('astro:page-load', initContentsToggle);
</script>
