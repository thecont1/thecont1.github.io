---
import type { CollectionEntry } from "astro:content";
import Lightbox from "../ui/Lightbox.astro";
import ContentsToggle from "../ui/ContentsToggle.astro";
import ScreenToggle from "../ui/ScreenToggle.astro";
import C2PAOverlay from "../ui/C2PAOverlay.astro";
import Note from "../ui/Note.astro";
import "../../styles/longform.css";

interface Props {
  post: CollectionEntry<"longform" | "photography" | "writing" | "datastories">;
}

const { post } = Astro.props;
const { Content, headings } = await post.render();

const backgroundColor = post.data.backgroundColor || "#ffffff";

// Build chapter structure: H2s are chapters, H3s are sections within chapters
const chapters = headings.filter((h) => h.depth === 2);
const allHeadings = headings.filter((h) => h.depth === 2 || h.depth === 3);

// Build nested TOC structure
interface TocItem {
  slug: string;
  text: string;
  depth: number;
  sections?: TocItem[];
}

const tocStructure: TocItem[] = [];
let currentChapter: TocItem | null = null;

allHeadings.forEach((h) => {
  if (h.depth === 2) {
    currentChapter = { slug: h.slug, text: h.text, depth: 2, sections: [] };
    tocStructure.push(currentChapter);
  } else if (h.depth === 3 && currentChapter) {
    currentChapter.sections?.push({ slug: h.slug, text: h.text, depth: 3 });
  }
});

// Formatting date
const formattedDate = post.data.date?.toLocaleDateString("en-US", {
  year: "numeric",
  month: "long",
  day: "numeric",
});

const tags = [...(post.data.theme || []), ...(post.data.geography || [])];
const totalChapters = chapters.length;
---

<article class="longform-post" style={`--page-bg: ${backgroundColor};`} data-total-chapters={totalChapters}>
  <header class="post-header">
    <div class="post-meta-top">
      <span class="collection-type">Longform</span>
      {post.data.category && <span class="category">{post.data.category}</span>}
      {formattedDate && <time datetime={post.data.date?.toISOString()}>{formattedDate}</time>}
    </div>
    
    <h1 class="post-title">{post.data.title}</h1>
    
    {post.data.subtitle && <p class="post-lead">{post.data.subtitle}</p>}

    <div class="post-author-line">
      <span class="by">by</span>
      <span class="author-name">{post.data.author}</span>
    </div>

    {post.data.showhero !== false && post.data.heroImage && (
      <figure class="post-hero">
        <img src={post.data.heroImage} alt={post.data.title} />
      </figure>
    )}
  </header>

  <div class="longform-layout-container">
    {post.data.toc !== false && tocStructure.length > 0 && (
      <ContentsToggle title={post.data.title} label="Chapters">
        <ul>
          {tocStructure.map((chapter, idx) => (
            <li class={idx === 0 ? 'active' : ''} data-chapter={chapter.slug}>
              <a href={`#${chapter.slug}`}>{chapter.text}</a>
            </li>
          ))}
        </ul>
      </ContentsToggle>
    )}

    <div class="post-body" id="longform-content">
      <Content components={{ Note, note: Note }} />
    </div>

    <!-- Chapter Navigation -->
    {chapters.length > 1 && (
      <nav class="chapter-nav" aria-label="Chapter navigation">
        <button class="chapter-nav-btn prev" disabled aria-label="Previous chapter">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
          <span class="nav-label">Previous</span>
        </button>
        <div class="chapter-progress">
          <span class="current-chapter">1</span> / <span class="total-chapters">{totalChapters}</span>
        </div>
        <button class="chapter-nav-btn next" aria-label="Next chapter">
          <span class="nav-label">Next</span>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9 18 15 12 9 6"></polyline>
          </svg>
        </button>
      </nav>
    )}
  </div>

  <Lightbox selector=".post-body" gallery={post.data.lightbox?.gallery} />
  <ScreenToggle />
  <C2PAOverlay />
</article>

<script>
  function setupLongformPagination() {
    const content = document.getElementById('longform-content');
    const article = document.querySelector('.longform-post') as HTMLElement;
    if (!content || !article) return;

    // Check if already processed
    if (content.querySelector('.chapter-page')) return;

    // Get all direct children as an array (before modifying DOM)
    const children = Array.from(content.children) as HTMLElement[];
    
    // Find all H2s to determine chapter count
    const h2Elements = children.filter(el => el.tagName === 'H2');
    if (h2Elements.length === 0) return;

    let currentChapterIndex = 0;

    // Chapter navigation elements
    const prevBtn = document.querySelector('.chapter-nav-btn.prev') as HTMLButtonElement;
    const nextBtn = document.querySelector('.chapter-nav-btn.next') as HTMLButtonElement;
    const currentChapterEl = document.querySelector('.current-chapter');
    const chapterItems = document.querySelectorAll('.sticky-toc ul > li');

    // Build chapter pages by grouping elements between H2s
    const chapterPages: HTMLDivElement[] = [];
    let currentChapterDiv: HTMLDivElement | null = null;
    let introElements: HTMLElement[] = [];

    children.forEach(el => {
      if (el.tagName === 'H2') {
        // Start a new chapter
        currentChapterDiv = document.createElement('div');
        currentChapterDiv.className = 'chapter-page';
        currentChapterDiv.dataset.chapterSlug = el.id;
        
        // If this is the first chapter and we have intro content, add it first
        if (chapterPages.length === 0 && introElements.length > 0) {
          const introWrapper = document.createElement('div');
          introWrapper.className = 'chapter-intro';
          introElements.forEach(introEl => introWrapper.appendChild(introEl));
          currentChapterDiv.appendChild(introWrapper);
        }
        
        currentChapterDiv.appendChild(el);
        chapterPages.push(currentChapterDiv);
      } else if (currentChapterDiv) {
        // Add to current chapter
        currentChapterDiv.appendChild(el);
      } else {
        // Content before first H2 - store for later
        introElements.push(el);
      }
    });

    // Clear content and add chapter pages
    content.innerHTML = '';
    chapterPages.forEach(page => content.appendChild(page));
    
    // Dropcaps setup
    content.querySelectorAll('.dropcap').forEach(p => {
      const text = p.textContent || "";
      if (text.length > 0) {
        p.setAttribute('data-letter', text.charAt(0));
      }
    });

    // Show only current chapter
    function showChapter(index: number) {
      if (index < 0 || index >= chapterPages.length) return;
      
      currentChapterIndex = index;
      
      // Hide all chapters, show current
      chapterPages.forEach((page, idx) => {
        if (idx === index) {
          page.classList.add('active');
        } else {
          page.classList.remove('active');
        }
      });

      // Update nav buttons
      if (prevBtn) prevBtn.disabled = index === 0;
      if (nextBtn) nextBtn.disabled = index >= chapterPages.length - 1;
      if (currentChapterEl) currentChapterEl.textContent = String(index + 1);

      // Update TOC active state
      chapterItems.forEach((item, idx) => {
        item.classList.toggle('active', idx === index);
      });

      // Update URL hash
      const currentPage = chapterPages[index];
      if (currentPage?.dataset.chapterSlug) {
        history.replaceState(null, '', `#${currentPage.dataset.chapterSlug}`);
      }

      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Button handlers
    if (prevBtn) {
      prevBtn.addEventListener('click', () => showChapter(currentChapterIndex - 1));
    }
    if (nextBtn) {
      nextBtn.addEventListener('click', () => showChapter(currentChapterIndex + 1));
    }

    // TOC click handlers
    chapterItems.forEach((item, idx) => {
      const link = item.querySelector('a');
      if (link) {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          showChapter(idx);
          // Close sidebar after selection
          const sidebar = document.getElementById('toc-sidebar');
          const toggle = document.getElementById('toc-toggle');
          if (sidebar) sidebar.classList.remove('is-open');
          if (toggle) toggle.classList.remove('active');
        });
      }
    });

    // Initial state from hash
    const hash = window.location.hash.replace('#', '');
    if (hash) {
      const targetIdx = chapterPages.findIndex(page => page.dataset.chapterSlug === hash);
      if (targetIdx !== -1) {
        currentChapterIndex = targetIdx;
      }
    }

    // Show first chapter (or from hash)
    showChapter(currentChapterIndex);
  }

  // Sync header background and auto-captions
  function refineLongformContent() {
    const article = document.querySelector('.longform-post') as HTMLElement;
    if (!article) return;

    // Background Sync - ensure it reads the CSS variable correctly
    const bgColor = getComputedStyle(article).getPropertyValue('--page-bg').trim();
    const header = document.querySelector('.site-header') as HTMLElement;
    if (header && bgColor) {
      header.style.backgroundColor = bgColor;
      header.style.transition = 'background-color 0.3s ease';
      const headerInner = header.querySelector('.site-header-inner') as HTMLElement;
      if (headerInner) headerInner.style.backgroundColor = 'transparent';
    }

    // Auto-captions from alt text
    const content = document.getElementById('longform-content');
    if (content) {
      content.querySelectorAll('img').forEach(img => {
        const imgEl = img as HTMLImageElement;
        if (imgEl.alt && !imgEl.closest('figure')?.querySelector('figcaption')) {
          const figure = imgEl.closest('figure') || document.createElement('figure');
          if (!imgEl.closest('figure')) {
            imgEl.parentNode?.insertBefore(figure, imgEl);
            figure.appendChild(imgEl);
          }
          const caption = document.createElement('figcaption');
          caption.className = 'image-caption';
          caption.textContent = imgEl.alt;
          figure.appendChild(caption);
        }
      });
    }
  }

  setupLongformPagination();
  refineLongformContent();
  
  document.addEventListener('astro:page-load', () => {
    setupLongformPagination();
    refineLongformContent();
  });
</script>
