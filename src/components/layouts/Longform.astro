---
import type { CollectionEntry } from "astro:content";
import Lightbox from "../ui/Lightbox.astro";
import ContentsToggle from "../ui/ContentsToggle.astro";
import ScreenToggle from "../ui/ScreenToggle.astro";
import C2PAOverlay from "../ui/C2PAOverlay.astro";
import "../../styles/longform.css";

interface Props {
  post: CollectionEntry<"photography" | "writing" | "datastories">;
}

const { post } = Astro.props;
const { Content, headings } = await post.render();

const backgroundColor = post.data.backgroundColor || "#ffffff";

// TOC logic: Filter for H2s for pagination
const sections = headings.filter((h) => h.depth === 2);

// Formatting date
const formattedDate = post.data.date?.toLocaleDateString("en-US", {
  year: "numeric",
  month: "long",
  day: "numeric",
});

const tags = [...(post.data.theme || []), ...(post.data.geography || [])];
---

<article class="longform-post" style={`--page-bg: ${backgroundColor};`}>
  <header class="post-header">
    <div class="post-meta-top">
      {post.data.category && <span class="category">{post.data.category}</span>}
      {formattedDate && <time datetime={post.data.date?.toISOString()}>{formattedDate}</time>}
    </div>
    
    <h1 class="post-title">{post.data.title}</h1>
    
    {post.data.excerpt && <p class="post-lead">{post.data.excerpt}</p>}

    <div class="post-author-line">
      <span class="by">by</span>
      <span class="author-name">Mahesh Shantaram</span>
    </div>

    {post.data.showhero !== false && post.data.heroImage && (
      <figure class="post-hero">
        <img src={post.data.heroImage} alt={post.data.title} />
      </figure>
    )}
  </header>

  <div class="longform-layout-container">
    {post.data.toc && sections.length > 0 && (
      <ContentsToggle title={post.data.title} label="Chapters">
        <ul>
          <li class="active" data-section="intro"><a href="#intro">Introduction</a></li>
          {sections.map((h) => (
            <li data-section={h.slug}><a href={`#${h.slug}`}>{h.text}</a></li>
          ))}
        </ul>
      </ContentsToggle>
    )}

    <div class="post-body" id="longform-content">
      <div class="section-wrapper active" id="section-intro">
         <Content />
      </div>
    </div>
  </div>

  <Lightbox selector=".post-body" gallery={post.data.lightbox?.gallery} />
  <ScreenToggle />
  <C2PAOverlay />
</article>

<script>
  function setupLongformPagination() {
    const content = document.getElementById('longform-content');
    if (!content) return;

    const navItems = document.querySelectorAll('.sticky-toc li');
    
    // Only run pagination logic if TOC is present
    if (navItems.length === 0) {
      // If no TOC, ensure all section wrappers are visible
      const wrappers = content.querySelectorAll('.section-wrapper');
      wrappers.forEach(sw => sw.classList.add('active'));
      return;
    }

    let currentWrapper = document.getElementById('section-intro');
    if (!currentWrapper) return;

    // Over-the-top Dropcaps
    const dropcaps = content.querySelectorAll('.dropcap');
    dropcaps.forEach(p => {
      const text = p.textContent || "";
      if (text.length > 0) {
        const firstLetter = text.charAt(0);
        p.setAttribute('data-letter', firstLetter);
      }
    });

    // Group content between H2s if not already grouped
    if (content.querySelectorAll('.section-wrapper').length <= 1) {
      const allNodes = Array.from(currentWrapper.childNodes);
      currentWrapper.innerHTML = '';

      allNodes.forEach(node => {
        if (node.nodeName === 'H2') {
          const h2 = node as HTMLElement;
          const sectionId = h2.id || h2.textContent?.toLowerCase().replace(/\s+/g, '-');
          h2.id = sectionId || '';
          
          const newWrapper = document.createElement('div');
          newWrapper.className = 'section-wrapper';
          newWrapper.id = `section-${sectionId}`;
          newWrapper.appendChild(h2);
          content.appendChild(newWrapper);
          currentWrapper = newWrapper;
        } else if (currentWrapper) {
          currentWrapper.appendChild(node);
        }
      });
    }

    // Handle navigation
    function showSection(sectionId: string) {
      const wrappers = document.querySelectorAll('.section-wrapper');
      wrappers.forEach(sw => sw.classList.remove('active'));
      
      const target = document.getElementById(`section-${sectionId}`);
      if (target) {
        target.classList.add('active');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      navItems.forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('data-section') === sectionId) {
          item.classList.add('active');
        }
      });
    }

    navItems.forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        const sectionId = item.getAttribute('data-section');
        if (sectionId) {
          showSection(sectionId);
          history.pushState(null, '', `#${sectionId}`);
        }
      });
    });

    // Initial load from hash
    const hash = window.location.hash.replace('#', '');
    if (hash) {
      showSection(hash);
    }
  }

  function setOrientation(img: HTMLImageElement) {
    const isHorizontal = img.naturalWidth > img.naturalHeight;
    img.classList.add(isHorizontal ? 'is-horizontal' : 'is-vertical');
    const figure = img.closest('figure');
    if (figure) figure.classList.add(isHorizontal ? 'is-horizontal' : 'is-vertical');
  }

  // Update menubar background and auto-captions
  function refineLongformContent() {
    const article = document.querySelector('.longform-post') as HTMLElement;
    if (article) {
      // Background Sync
      const bgColor = getComputedStyle(article).getPropertyValue('--page-bg');
      const header = document.querySelector('.site-header') as HTMLElement;
      if (header) {
        header.style.backgroundColor = bgColor;
        header.style.transition = 'background-color 0.3s ease';
        const headerInner = header.querySelector('.site-header-inner') as HTMLElement;
        if (headerInner) headerInner.style.backgroundColor = 'transparent';
      }

      // Auto-captions from alt text
      const content = document.getElementById('longform-content');
      if (content) {
        const images = content.querySelectorAll('img');
        images.forEach(img => {
          const imgEl = img as HTMLImageElement;
          if (imgEl.alt && !imgEl.closest('figure')?.querySelector('figcaption')) {
            const figure = imgEl.closest('figure') || document.createElement('figure');
            if (!imgEl.closest('figure')) {
              imgEl.parentNode?.insertBefore(figure, imgEl);
              figure.appendChild(imgEl);
            }
            const caption = document.createElement('figcaption');
            caption.className = 'image-caption';
            caption.textContent = imgEl.alt;
            figure.appendChild(caption);
          }
        });
      }
    }
  }

  setupLongformPagination();
  refineLongformContent();
  
  document.addEventListener('astro:page-load', () => {
    setupLongformPagination();
    refineLongformContent();
  });
</script>
