---
import type { CollectionEntry } from "astro:content";
import SiteHeader from "../SiteHeader.astro";
import SiteFooter from "../SiteFooter.astro";
import { AUTHOR } from "../../data/author";
import "../../styles/global.css";
import "../../styles/header.css";
import "../../styles/footer.css";
import "../../styles/code.css";

interface Props {
  post: CollectionEntry<"code">;
}

const { post } = Astro.props;
const { Content } = await post.render();

const backgroundColor = post.data.backgroundColor || "#0f0f23";

// Format the last updated date
const formattedDate = post.data.lastUpdated?.toLocaleDateString("en-US", {
  year: "numeric",
  month: "long",
  day: "numeric",
}) || post.data.date?.toLocaleDateString("en-US", {
  year: "numeric",
  month: "long",
  day: "numeric",
});

// Generate language color based on language
const getLanguageColor = (language: string) => {
  const colors: Record<string, string> = {
    'JavaScript': '#f1e05a',
    'TypeScript': '#3178c6',
    'Python': '#3572A5',
    'Java': '#b07219',
    'C++': '#f34b7d',
    'C': '#555555',
    'Go': '#00ADD8',
    'Rust': '#dea584',
    'PHP': '#4F5D95',
    'Ruby': '#701516',
    'Swift': '#fa7343',
    'Kotlin': '#A97BFF',
    'Dart': '#00B4AB',
    'HTML': '#e34c26',
    'CSS': '#1572B6',
    'Vue': '#4FC08D',
    'React': '#61DAFB',
  };
  return colors[language] || '#6e7681';
};

const languageColor = post.data.language ? getLanguageColor(post.data.language) : '#6e7681';

const metaDescription = post.data.description || post.data.subtitle || AUTHOR.description;
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const ogImage = new URL(AUTHOR.image, Astro.site).href;

const codeJsonLd = {
  "@context": "https://schema.org",
  "@type": "SoftwareSourceCode",
  name: post.data.title,
  ...(post.data.description && { description: post.data.description }),
  ...(post.data.date && { dateCreated: post.data.date.toISOString() }),
  ...(post.data.repoUrl && { codeRepository: post.data.repoUrl }),
  ...(post.data.language && { programmingLanguage: post.data.language }),
  ...(post.data.license && { license: post.data.license }),
  author: {
    "@type": "Person",
    name: AUTHOR.name,
    url: AUTHOR.url,
    sameAs: AUTHOR.sameAs,
  },
  mainEntityOfPage: {
    "@type": "WebPage",
    "@id": canonicalURL.href,
  },
};

const personJsonLd = {
  "@context": "https://schema.org",
  "@type": "Person",
  name: AUTHOR.name,
  url: AUTHOR.url,
  email: AUTHOR.email,
  jobTitle: AUTHOR.jobTitle,
  description: AUTHOR.description,
  image: ogImage,
  sameAs: AUTHOR.sameAs,
};
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{post.data.title} | Code Project | Mahesh Shantaram</title>
  <meta name="description" content={metaDescription} />
  <link rel="canonical" href={canonicalURL.href} />

  <!-- Open Graph -->
  <meta property="og:title" content={`${post.data.title} | Code Project | Mahesh Shantaram`} />
  <meta property="og:description" content={metaDescription} />
  <meta property="og:image" content={ogImage} />
  <meta property="og:url" content={canonicalURL.href} />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Mahesh Shantaram" />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="@thecontrarian" />
  <meta name="twitter:title" content={`${post.data.title} | Code Project | Mahesh Shantaram`} />
  <meta name="twitter:description" content={metaDescription} />
  <meta name="twitter:image" content={ogImage} />

  <!-- Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify(codeJsonLd)} />
  <script type="application/ld+json" set:html={JSON.stringify(personJsonLd)} />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&family=Fraunces:opsz,wght@9..144,400;9..144,600&display=swap" rel="stylesheet">
</head>

<body>
  <!-- Snow canvas for snow effect -->
  <canvas id="snow-canvas" aria-hidden="true"></canvas>
  
  <!-- Site Header -->
  <SiteHeader />

  <div class="repo-showcase" style={`--bg-color: ${backgroundColor}; --lang-color: ${languageColor};`}>
    <!-- Animated background -->
    <div class="bg-animation">
      <div class="bg-grid"></div>
      <div class="bg-gradient"></div>
    </div>

    <!-- Header with repository info -->
    <header class="repo-header">
      <div class="repo-container">
        <!-- Breadcrumb -->
        <nav class="breadcrumb">
          <a href="/" class="breadcrumb-link">Home</a>
          <span class="breadcrumb-separator">/</span>
          <a href="/code" class="breadcrumb-link">Code</a>
          <span class="breadcrumb-separator">/</span>
          <span class="breadcrumb-current">{post.data.repoName}</span>
        </nav>

        <!-- Repository title and metadata -->
        <div class="repo-title-section">
          <div class="repo-icon">
            <svg width="32" height="32" viewBox="0 0 16 16" fill="currentColor">
              <path d="M2 2.5A2.5 2.5 0 0 1 4.5 0h8.75a.75.75 0 0 1 .75.75v12.5a.75.75 0 0 1-.75.75h-2.5a.75.75 0 1 1 0-1.5h1.75v-2h-8a1 1 0 0 0-.714 1.7.75.75 0 0 1-1.072 1.05A2.495 2.495 0 0 1 2 11.5v-9zm10.5-1V9h-8c-.356 0-.694.074-1 .208V2.5a1 1 0 0 1 1-1h8zM5 12.25v3.25a.25.25 0 0 0 .4.2l1.45-1.087a.25.25 0 0 1 .3 0L8.6 15.7a.25.25 0 0 0 .4-.2v-3.25a.25.25 0 0 0-.25-.25h-3.5a.25.25 0 0 0-.25.25z"/>
            </svg>
          </div>
          
          <div class="repo-info">
            <h1 class="repo-title">
              <span class="repo-owner">{post.data.repoOwner}</span>
              <span class="repo-separator">/</span>
              <span class="repo-name">{post.data.repoName}</span>
            </h1>
            
            <p class="repo-author">by {post.data.author}</p>
            
            <p class="repo-description">{post.data.description}</p>
            
            <!-- Repository stats -->
            <div class="repo-stats">
              {post.data.language && (
                <div class="stat-item">
                  <div class="language-dot" style={`background-color: ${languageColor}`}></div>
                  <span>{post.data.language}</span>
                </div>
              )}
              
              {post.data.stars !== undefined && post.data.stars > 0 && (
                <div class="stat-item">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.75.75 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25z"/>
                  </svg>
                  <span>{post.data.stars.toLocaleString()}</span>
                </div>
              )}
              
              {post.data.forks !== undefined && post.data.forks > 0 && (
                <div class="stat-item">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M5 5.372v.878c0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75v-.878a2.25 2.25 0 1 1 1.5 0v.878a2.25 2.25 0 0 1-2.25 2.25h-1.5v2.128a2.251 2.251 0 1 1-1.5 0V8.5h-1.5A2.25 2.25 0 0 1 3.5 6.25v-.878a2.25 2.25 0 1 1 1.5 0ZM5 3.25a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0Zm6.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm-3 8.75a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0Z"/>
                  </svg>
                  <span>{post.data.forks.toLocaleString()}</span>
                </div>
              )}
              
              {post.data.license && (
                <div class="stat-item">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M8.75.75V2h.985c.304 0 .603.08.867.231l1.29.736c.038.022.08.033.124.033h2.234a.75.75 0 0 1 0 1.5h-.427l2.111 4.692a.75.75 0 0 1-.154.838l-.53-.53.529.531-.001.002-.002.002-.006.006-.016.015-.045.04c-.21.176-.441.327-.686.45C14.556 10.78 13.88 11 13 11a4.498 4.498 0 0 1-2.023-.454 3.544 3.544 0 0 1-.686-.45l-.045-.04-.016-.015-.006-.006-.002-.002v-.001a.75.75 0 0 1-.154-.838L12.178 4.5h-.162c-.305 0-.604-.079-.868-.231l-1.29-.736a.245.245 0 0 0-.124-.033H8.75V13h2.5a.75.75 0 0 1 0 1.5h-6.5a.75.75 0 0 1 0-1.5h2.5V3.5h-.984a.245.245 0 0 0-.124.033l-1.289.737c-.265.15-.564.23-.869.23h-.162l2.112 4.692a.75.75 0 0 1-.154.838l-.53-.53.529.531-.001.002-.002.002-.006.006-.016.015-.045.04c-.21.176-.441.327-.686.45C4.556 10.78 3.88 11 3 11a4.498 4.498 0 0 1-2.023-.454 3.544 3.544 0 0 1-.686-.45l-.045-.04-.016-.015-.006-.006-.002-.002v-.001a.75.75 0 0 1-.154-.838L2.178 4.5H1.75a.75.75 0 0 1 0-1.5h2.234a.249.249 0 0 0 .125-.033l1.288-.737c.265-.15.564-.23.869-.23h.984V.75a.75.75 0 0 1 1.5 0Z"/>
                  </svg>
                  <span>{post.data.license}</span>
                </div>
              )}
              
              {formattedDate && (
                <div class="stat-item">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M4.75 0a.75.75 0 0 1 .75.75V2h5V.75a.75.75 0 0 1 1.5 0V2h1.25c.966 0 1.75.784 1.75 1.75v11.5A1.75 1.75 0 0 1 13.25 17H2.75A1.75 1.75 0 0 1 1 15.25V3.75C1 2.784 1.784 2 2.75 2H4V.75A.75.75 0 0 1 4.75 0ZM2.5 7.5v7.75c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25V7.5Zm0-2.25V3.75a.25.25 0 0 1 .25-.25h10.5a.25.25 0 0 1 .25.25v1.5Z"/>
                  </svg>
                  <span>Updated {formattedDate}</span>
                </div>
              )}
            </div>
          </div>
        </div>

        <!-- Action buttons -->
        <div class="repo-actions">
          <a href={post.data.repoUrl} target="_blank" rel="noopener noreferrer" class="btn btn-primary">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
              <path d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.04-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"/>
            </svg>
            View on GitHub
          </a>
          
          {post.data.homepage && (
            <a href={post.data.homepage} target="_blank" rel="noopener noreferrer" class="btn btn-secondary">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"/>
              </svg>
              Live Demo
            </a>
          )}
        </div>
      </div>
    </header>

    <!-- Main content -->
    <main class="repo-content">
      <div class="repo-container">
        <div class="content-wrapper">
          <!-- Tags section -->
          {post.data.tags && post.data.tags.length > 0 && (
            <div class="tags-section">
              <h3 class="section-title">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M1 7.775V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 0 1 0 2.474l-5.026 5.026a1.75 1.75 0 0 1-2.474 0l-6.25-6.25A1.75 1.75 0 0 1 1 7.775Zm1.5 0c0 .066.026.13.073.177l6.25 6.25a.25.25 0 0 0 .354 0l5.025-5.025a.25.25 0 0 0 0-.354l-6.25-6.25a.25.25 0 0 0-.177-.073H2.75a.25.25 0 0 0-.25.25v5.025ZM6 5a1 1 0 1 1 0 2 1 1 0 0 1 0-2Z"/>
                </svg>
                Topics
              </h3>
              <div class="tags-grid">
                {post.data.tags.map(tag => (
                  <span class="tag">{tag}</span>
                ))}
              </div>
            </div>
          )}

          <!-- Content -->
          <div class="markdown-content">
            <Content />
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Site Footer -->
  <SiteFooter />

  <!-- JavaScript for site functionality -->
  <script is:inline src="/textmode.js" defer></script>
  <script is:inline src="/snow.js" defer></script>
  <script is:inline src="/mobile-nav.js" defer></script>

  <script>
    // Enhanced emoji and typography support
    document.addEventListener('DOMContentLoaded', function() {
      // Add emoji support class to body
      document.body.classList.add('emoji-enhanced');
      
      // Smooth scroll for anchor links
      document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (this: HTMLAnchorElement, e: Event) {
          e.preventDefault();
          const target = document.querySelector(this.getAttribute('href') || '');
          if (target) {
            target.scrollIntoView({
              behavior: 'smooth',
              block: 'start'
            });
          }
        });
      });

      // Add loading animation for images
      document.querySelectorAll('.markdown-content img').forEach((img: Element) => {
        const imgEl = img as HTMLImageElement;
        imgEl.addEventListener('load', function(this: HTMLImageElement) {
          this.style.opacity = '1';
          this.style.transform = 'translateY(0)';
        });
        
        // Set initial state
        imgEl.style.opacity = '0';
        imgEl.style.transform = 'translateY(20px)';
        imgEl.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
      });

      // Parallax effect for background
      let ticking = false;
      
      function updateParallax() {
        const scrolled = window.pageYOffset;
        const parallax = document.querySelector('.bg-animation') as HTMLElement;
        
        if (parallax) {
          const speed = scrolled * 0.5;
          parallax.style.transform = `translateY(${speed}px)`;
        }
        
        ticking = false;
      }

      function requestTick() {
        if (!ticking) {
          requestAnimationFrame(updateParallax);
          ticking = true;
        }
      }

      window.addEventListener('scroll', requestTick);
    });
  </script>
</body>
</html>