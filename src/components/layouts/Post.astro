---
import type { CollectionEntry } from "astro:content";
import Lightbox from "../ui/Lightbox.astro";
import C2PAOverlay from "../ui/C2PAOverlay.astro";
import Note from "../ui/Note.astro";
import "../../styles/global.css";
import "../../styles/header.css";
import "../../styles/footer.css";
import "../../styles/post.css";
import "../../styles/info-panel.css";

interface Props {
  post: CollectionEntry<"post">;
}

const { post } = Astro.props;
const { Content } = await post.render();

const backgroundColor = post.data.backgroundColor || "#ffffff";

// Formatting date - Economist style: "Mar 29th 2024"
const formattedDate = post.data.date?.toLocaleDateString("en-GB", {
  year: "numeric",
  month: "short",
  day: "numeric",
});

// Category/Theme labels
const tags = [...(post.data.theme || []), ...(post.data.geography || [])];
---

<style is:global>
  /* Immediate application to avoid flash of default background */
  html, body {
    background-color: var(--page-bg, #ffffff) !important;
  }

  :root {
    --page-bg: #ffffff;
  }

  /* Ensure transparency in layout parents */
  main,
  #snow-canvas {
    background: transparent !important;
    background-color: transparent !important;
  }

  .site-header {
    background-color: var(--page-bg, #ffffff) !important;
    backdrop-filter: blur(8px) !important;
    -webkit-backdrop-filter: blur(8px) !important;
  }

  .site-header-inner {
    background-color: transparent !important;
  }

  /* Improved contrast detection using data-bg attribute on html or body */
  html[data-bg^="#0"],
  html[data-bg^="#1"],
  html[data-bg^="#2"],
  html[data-bg="black"] {
    --ink: #eee;
    --muted: #aaa;
    --hairline: #333;
  }
</style>

<script is:inline define:vars={{ backgroundColor }}>
  (function() {
    const bg = backgroundColor || '#ffffff';
    // Set data-bg on html for CSS targeting
    document.documentElement.setAttribute('data-bg', bg);
    document.documentElement.style.setProperty('--page-bg', bg);
    document.documentElement.style.setProperty('background-color', bg, 'important');
    // Also set on body to be safe
    document.body.setAttribute('data-bg', bg);
    document.body.style.setProperty('--page-bg', bg);
    document.body.style.setProperty('background-color', bg, 'important');
  })();
</script>

<article class="simple-post" data-bg={backgroundColor}>
  <header class="post-header">
    <div class="post-kicker">
      <span class="collection-type">Post</span>
      {(post.data as any).category && <span class="category">{(post.data as any).category}</span>}
    </div>
    
    <h1 class="post-title">{post.data.title}</h1>
    
    <div class="post-author-row">
        <div class="post-meta-details">
          {formattedDate && <time datetime={post.data.date?.toISOString()}>{formattedDate}</time>}
          <span class="dot">Â·</span>
          <span class="author-name">{post.data.author}</span>
        </div>
    </div>
  </header>

  <div class="post-interactions-bar">
    {post.data.subtitle && <p class="post-subtitle">{post.data.subtitle}</p>}
  </div>

  <div class="post-layout-container">
    <div class="post-body">
      <Content components={{ Note, note: Note }} />
      
      <footer class="post-footer">
        {tags.length > 0 && (
          <div class="post-tags">
            {tags.map(tag => <span class="tag">#{tag}</span>)}
          </div>
        )}
      </footer>
    </div>
  </div>

  {(post.data.lightbox?.gallery ?? false) && (
    <Lightbox 
      selector=".post-body" 
      gallery={true} 
    />
  )}
  <C2PAOverlay />
</article>

<script>
  function setupPostLayout() {
    const postBody = document.querySelector('.post-body');
    if (!postBody) return;

    // Handle image orientation and aspect ratio for C2PA positioning
    const images = postBody.querySelectorAll('img');
    images.forEach(img => {
      const handleImg = (el: HTMLImageElement) => {
        const ratio = el.naturalWidth / el.naturalHeight;
        el.style.setProperty('--aspect-ratio', ratio.toString());
        
        if (el.naturalHeight > el.naturalWidth) {
          el.classList.add('is-vertical');
          el.closest('figure')?.classList.add('is-vertical');
        } else {
          el.classList.add('is-horizontal');
          el.closest('figure')?.classList.add('is-horizontal');
        }
      };

      if (img.complete) handleImg(img);
      else img.addEventListener('load', () => handleImg(img));
    });

    // Render caption below each image (caption comes from markdown alt text)
    images.forEach((img) => {
      if (img.dataset.hasInlineCaption === 'true') return;
      const captionText = (img.getAttribute('alt') || '').trim();
      if (!captionText) {
        img.dataset.hasInlineCaption = 'true';
        return;
      }

      const existingFigure = img.closest('figure');
      if (existingFigure) {
        if (!existingFigure.querySelector('figcaption')) {
          const figcaption = document.createElement('figcaption');
          figcaption.textContent = captionText;
          existingFigure.appendChild(figcaption);
        }
        img.dataset.hasInlineCaption = 'true';
        return;
      }

      const figure = document.createElement('figure');
      const figcaption = document.createElement('figcaption');
      figcaption.textContent = captionText;

      const parent = img.parentNode;
      if (!parent) return;
      parent.insertBefore(figure, img);
      figure.appendChild(img);
      figure.appendChild(figcaption);

      img.dataset.hasInlineCaption = 'true';
    });

  }

  // Initial load and Astro page transitions
  setupPostLayout();
  document.addEventListener('astro:page-load', setupPostLayout);
</script>
