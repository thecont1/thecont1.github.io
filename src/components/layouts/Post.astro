---
import type { CollectionEntry } from "astro:content";
import Lightbox from "../ui/Lightbox.astro";
import C2PAOverlay from "../ui/C2PAOverlay.astro";
import "../../styles/global.css";
import "../../styles/header.css";
import "../../styles/footer.css";
import "../../styles/post.css";

interface Props {
  post: CollectionEntry<"photography" | "writing" | "datastories">;
}

const { post } = Astro.props;
const { Content } = await post.render();

const backgroundColor = post.data.backgroundColor || post.data['background-color'] || "#ffffff";
console.log(`Rendering Post: ${post.data.title}, BG: ${backgroundColor}`);

// Formatting date - Economist style: "Mar 29th 2024"
const formattedDate = post.data.date?.toLocaleDateString("en-GB", {
  year: "numeric",
  month: "short",
  day: "numeric",
});

// Category/Theme labels
const tags = [...(post.data.theme || []), ...(post.data.geography || [])];
---

<style is:global define:vars={{ backgroundColor }}>
  /* Very aggressive override */
  :root {
    --page-bg: var(--backgroundColor);
  }

  html, 
  body, 
  main,
  #app, 
  #root, 
  .post-layout-container, 
  .simple-post {
    background: var(--backgroundColor) !important;
    background-color: var(--backgroundColor) !important;
  }
  
  /* Ensure header also gets the background color */
  .site-header {
    background-color: var(--backgroundColor) !important;
    backdrop-filter: blur(8px) !important;
    -webkit-backdrop-filter: blur(8px) !important;
  }
  
  .site-header-inner {
    background-color: transparent !important;
  }
</style>

<article class="simple-post" data-bg={backgroundColor} style={`--page-bg: ${backgroundColor};`}>
  <header class="post-header">
    <h1 class="post-title">{post.data.title}</h1>
    
    {post.data.excerpt && <p class="post-lead">{post.data.excerpt}</p>}

    <div class="post-byline">
      {formattedDate && <time datetime={post.data.date?.toISOString()}>{formattedDate}</time>}
      <span class="separator">|</span>
      <span class="location">MAHESH SHANTARAM</span>
    </div>
  </header>

  <div class="post-layout-container">
    <div class="post-body">
      <Content />
      
      <footer class="post-footer">
        {tags.length > 0 && (
          <div class="post-tags">
            {tags.map(tag => <span class="tag">#{tag}</span>)}
          </div>
        )}
      </footer>
    </div>
  </div>

  {post.data.lightbox?.gallery && (
    <Lightbox selector=".post-body" gallery={true} />
  )}
  <C2PAOverlay />
</article>

<script>
  // Sync header background with page background
  function refinePostContent() {
    const article = document.querySelector('.simple-post') as HTMLElement;
    console.log('Post Layout: refining content');
    if (article) {
      const bgColor = article.style.getPropertyValue('--page-bg').trim() || 
                      getComputedStyle(article).getPropertyValue('--page-bg').trim();
      
      console.log('Post Layout: applying bgColor', bgColor);
      if (bgColor) {
        // Direct injection to HTML and Body
        document.documentElement.style.backgroundColor = bgColor;
        document.body.style.backgroundColor = bgColor;
        
        // Force important on all potential containers
        const styleId = 'dynamic-post-bg';
        let style = document.getElementById(styleId);
        if (!style) {
          style = document.createElement('style');
          style.id = styleId;
          document.head.appendChild(style);
        }
        style.textContent = `
          html, body, main, #app, #root, .post-layout-container, .simple-post { 
            background-color: ${bgColor} !important; 
          }
        `;
        
        document.body.classList.add('simple-post-active');
      }

      const header = document.querySelector('.site-header') as HTMLElement;
      if (header) {
        header.style.backgroundColor = bgColor;
        header.style.transition = 'background-color 0.3s ease';
        const headerInner = header.querySelector('.site-header-inner') as HTMLElement;
        if (headerInner) headerInner.style.backgroundColor = 'transparent';
      }
    }
  }

  refinePostContent();
  document.addEventListener('astro:page-load', refinePostContent);
</script>
