---
import type { CollectionEntry } from "astro:content";
import Lightbox from "../ui/Lightbox.astro";
import ScreenToggle from "../ui/ScreenToggle.astro";
import C2PAOverlay from "../ui/C2PAOverlay.astro";
import ContentsToggle from "../ui/ContentsToggle.astro";
import "../../styles/post.css";

interface Props {
  post: CollectionEntry<"photography" | "writing" | "datastories">;
}

const { post } = Astro.props;
const { Content, headings } = await post.render();

const backgroundColor = post.data.backgroundColor || "#ffffff";

// TOC logic: Filter for H2s
const toc = headings.filter((h) => h.depth === 2);

// Formatting date
const formattedDate = post.data.date?.toLocaleDateString("en-US", {
  year: "numeric",
  month: "long",
  day: "numeric",
});

// Category/Theme labels
const tags = [...(post.data.theme || []), ...(post.data.geography || [])];
---

<article class="simple-post" style={`--page-bg: ${backgroundColor};`}>
  <header class="post-header">
    <div class="post-meta-top">
      {post.data.category && <span class="category">{post.data.category}</span>}
      {formattedDate && <time datetime={post.data.date?.toISOString()}>{formattedDate}</time>}
    </div>
    
    <h1 class="post-title">{post.data.title}</h1>
    
    {post.data.excerpt && <p class="post-lead">{post.data.excerpt}</p>}

    <div class="post-author-line">
      <span class="by">by</span>
      <span class="author-name">Mahesh Shantaram</span>
    </div>

    {post.data.showhero !== false && post.data.heroImage && (
      <figure class="post-hero">
        <img src={post.data.heroImage} alt={post.data.title} />
      </figure>
    )}
  </header>

  <div class="post-layout-container">
    {post.data.toc && toc.length > 0 && (
      <ContentsToggle title={post.data.title}>
        <ul>
          {toc.map((h) => (
            <li><a href={`#${h.slug}`}>{h.text}</a></li>
          ))}
        </ul>
      </ContentsToggle>
    )}

    <div class="post-body">
      <Content />
      
      <footer class="post-footer">
        {tags.length > 0 && (
          <div class="post-tags">
            {tags.map(tag => <span class="tag">#{tag}</span>)}
          </div>
        )}
      </footer>
    </div>
  </div>

  <Lightbox selector=".post-body" gallery={post.data.lightbox?.gallery} />
  <ScreenToggle />
  <C2PAOverlay />
</article>

<script>
  function tagImageOrientation() {
    const images = document.querySelectorAll('.post-body img');
    images.forEach(img => {
      const imgElement = img as HTMLImageElement;
      if (imgElement.complete) {
        setOrientation(imgElement);
      } else {
        imgElement.onload = () => setOrientation(imgElement);
      }
    });
  }

  function setOrientation(img: HTMLImageElement) {
    const isHorizontal = img.naturalWidth > img.naturalHeight;
    img.classList.add(isHorizontal ? 'is-horizontal' : 'is-vertical');
    const figure = img.closest('figure');
    if (figure) {
      figure.classList.add(isHorizontal ? 'is-horizontal' : 'is-vertical');
    }
  }

  // Update menubar background and auto-captions
  function refinePostContent() {
    const article = document.querySelector('.simple-post') as HTMLElement;
    if (article) {
      // Background Sync
      const bgColor = getComputedStyle(article).getPropertyValue('--page-bg');
      const header = document.querySelector('.site-header') as HTMLElement;
      if (header) {
        header.style.backgroundColor = bgColor;
        header.style.transition = 'background-color 0.3s ease';
        const headerInner = header.querySelector('.site-header-inner') as HTMLElement;
        if (headerInner) headerInner.style.backgroundColor = 'transparent';
      }

      // Auto-captions from alt text
      const images = article.querySelectorAll('.post-body img');
      images.forEach(img => {
        const imgEl = img as HTMLImageElement;
        if (imgEl.alt && !imgEl.closest('figure')?.querySelector('figcaption')) {
          const figure = imgEl.closest('figure') || document.createElement('figure');
          if (!imgEl.closest('figure')) {
            imgEl.parentNode?.insertBefore(figure, imgEl);
            figure.appendChild(imgEl);
          }
          const caption = document.createElement('figcaption');
          caption.className = 'image-caption';
          caption.textContent = imgEl.alt;
          figure.appendChild(caption);
        }
      });
    }
  }

  // Handle dropcaps and header sync
  function initPostFeatures() {
    const article = document.querySelector('.simple-post') as HTMLElement;
    if (!article) return;

    // Over-the-top Dropcaps
    const dropcaps = article.querySelectorAll('.dropcap');
    dropcaps.forEach(p => {
      const text = p.textContent || "";
      if (text.length > 0) {
        const firstLetter = text.charAt(0);
        p.setAttribute('data-letter', firstLetter);
      }
    });
  }

  tagImageOrientation();
  refinePostContent();
  initPostFeatures();
  
  document.addEventListener('astro:page-load', () => {
    tagImageOrientation();
    refinePostContent();
    initPostFeatures();
  });
</script>
