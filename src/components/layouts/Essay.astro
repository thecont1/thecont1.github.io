---
import type { CollectionEntry } from "astro:content";
import Lightbox from "../ui/Lightbox.astro";
import ScreenToggle from "../ui/ScreenToggle.astro";
import ContentsToggle from "../ui/ContentsToggle.astro";
import C2PAOverlay from "../ui/C2PAOverlay.astro";
import Note from "../ui/Note.astro";
import "../../styles/essay.css";

interface Props {
  post: CollectionEntry<"essay">;
}

const { post } = Astro.props;
const { Content, headings } = await post.render();

const backgroundColor = post.data.backgroundColor || "#f9e4e4";

// TOC logic: Filter for H2s - Keep original text as requested
const toc = headings.filter((h) => h.depth === 2);

// Formatting date
const formattedDate = post.data.date?.toLocaleDateString("en-US", {
  year: "numeric",
  month: "long",
  day: "numeric",
});

// Category/Theme labels
const tags = [...(post.data.theme || []), ...(post.data.geography || [])];

const lightboxEnabled = post.data.lightbox?.gallery !== false;
---

<article class="editorial-post" id="top" style={`--page-bg: ${backgroundColor};`}>
  <header class="post-header">
    <div class="post-kicker">
      <span class="collection-type">Essay</span>
      {(post.data as any).category && <span class="category">{(post.data as any).category}</span>}
      {(post.data as any).project && <span class="category">{(post.data as any).project}</span>}
    </div>

    <h1 class="post-title">{post.data.title}</h1>

    {post.data.subtitle && <p class="post-subtitle">{post.data.subtitle}</p>}

    <div class="post-author-line">
      <span class="by">By</span><span class="author-name">{post.data.author}</span>
    </div>

    {formattedDate && (
      <div class="post-date-line">
        <time datetime={post.data.date?.toISOString()}>{formattedDate}</time>
      </div>
    )}

    {post.data.showhero !== false && post.data.heroImage && (
      <figure class="post-hero">
        <img src={post.data.heroImage} alt={post.data.title} />
      </figure>
    )}
  </header>

  <div class="post-layout-container">
    {post.data.toc && toc.length > 0 && (
      <ContentsToggle title={post.data.title}>
        <ul>
          {toc.map((h) => (
            <li><a href={`#${h.slug}`}>{h.text}</a></li>
          ))}
        </ul>
      </ContentsToggle>
    )}

    <div class="post-body">
      <Content components={{ Note, note: Note }} />
      
      <footer class="post-footer">
        {tags.length > 0 && (
          <div class="post-tags">
            {tags.map(tag => <span class="tag">#{tag}</span>)}
          </div>
        )}
      </footer>
    </div>
  </div>

  {lightboxEnabled && (
    <Lightbox selector=".post-body" includeHero={post.data.showhero !== false && !!post.data.heroImage} gallery={true} />
  )}

  <ScreenToggle />
  <C2PAOverlay />
</article>

<script>
  function tagImageOrientation() {
    const images = document.querySelectorAll('.post-body img');
    images.forEach(img => {
      const imgElement = img as HTMLImageElement;
      if (imgElement.complete) {
        setOrientation(imgElement);
      } else {
        imgElement.onload = () => setOrientation(imgElement);
      }
    });
  }

  function setOrientation(img: HTMLImageElement) {
    const isHorizontal = img.naturalWidth > img.naturalHeight;
    img.classList.add(isHorizontal ? 'is-horizontal' : 'is-vertical');
    const figure = img.closest('figure');
    if (figure) {
      figure.classList.add(isHorizontal ? 'is-horizontal' : 'is-vertical');
    }
  }

  // Update menubar background and auto-captions
  function refineEssayContent() {
    const article = document.querySelector('.editorial-post') as HTMLElement;
    if (article) {
      // Background Sync
      const header = document.querySelector('.site-header') as HTMLElement;
      if (header) {
        // Use a translucent version of the page background if possible, otherwise fallback to translucent white
        header.style.backgroundColor = 'rgba(249, 228, 228, 0.0)'; 
        header.style.backdropFilter = 'blur(6px)';
        (header.style as any).webkitBackdropFilter = 'blur(6px)';
        header.style.borderBottom = '1px solid rgba(0,0,0,0.1)';
        header.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
        
        const headerInner = header.querySelector('.site-header-inner') as HTMLElement;
        if (headerInner) {
          headerInner.style.backgroundColor = 'transparent';
          headerInner.style.backdropFilter = 'none';
        }
      }

      // Auto-captions from alt text
      const images = article.querySelectorAll('.post-body img');
      images.forEach(img => {
        const imgEl = img as HTMLImageElement;
        if (imgEl.alt && !imgEl.closest('figure')?.querySelector('figcaption')) {
          const wrap = imgEl.closest('.c2pa-media-wrap') as HTMLElement | null;
          const nodeToMove = wrap || imgEl;
          const existingFigure = nodeToMove.closest('figure');
          const figure = existingFigure || document.createElement('figure');
          if (!existingFigure) {
            nodeToMove.parentNode?.insertBefore(figure, nodeToMove);
            figure.appendChild(nodeToMove);
          }
          const caption = document.createElement('figcaption');
          caption.className = 'image-caption';
          caption.textContent = imgEl.alt;
          figure.appendChild(caption);
        }
      });
    }
  }

  // Handle dropcaps and TOC toggle
  function initEditorialFeatures() {
    const article = document.querySelector('.editorial-post') as HTMLElement;
    if (!article) {
      return;
    }

    // Over-the-top Dropcaps
    const dropcaps = article.querySelectorAll('.dropcap');
    dropcaps.forEach(p => {
      const text = p.textContent || "";
      if (text.length > 0) {
        const firstLetter = text.charAt(0);
        p.setAttribute('data-letter', firstLetter);
      }
    });
  }

  tagImageOrientation();
  refineEssayContent();
  initEditorialFeatures();
  
  document.addEventListener('astro:page-load', () => {
    tagImageOrientation();
    refineEssayContent();
    initEditorialFeatures();
  });
</script>
