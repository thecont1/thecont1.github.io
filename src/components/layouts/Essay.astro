---
import type { CollectionEntry } from "astro:content";
import Lightbox from "../ui/Lightbox.astro";
import "../../styles/essay.css";

interface Props {
  post: CollectionEntry<"photography" | "writing" | "datastories">;
}

const { post } = Astro.props;
const { Content, headings } = await post.render();

const backgroundColor = post.data.backgroundColor || "#f9e4e4";

// TOC logic: Filter for H2s - Keep original text as requested
const toc = headings.filter((h) => h.depth === 2);

// Formatting date
const formattedDate = post.data.date?.toLocaleDateString("en-US", {
  year: "numeric",
  month: "long",
  day: "numeric",
});

// Category/Theme labels
const tags = [...(post.data.theme || []), ...(post.data.geography || [])];
---

<article class="editorial-post" style={`--page-bg: ${backgroundColor};`}>
  <header class="post-header">
    <div class="post-meta-top">
      {post.data.category && <span class="category">{post.data.category}</span>}
      {formattedDate && <time datetime={post.data.date?.toISOString()}>{formattedDate}</time>}
    </div>
    
    <h1 class="post-title">{post.data.title}</h1>
    
    {post.data.excerpt && <p class="post-lead">{post.data.excerpt}</p>}

    <div class="post-author-line">
      <span class="by">by</span>
      <span class="author-name">Mahesh Shantaram</span>
    </div>

    {post.data.heroImage && (
      <figure class="post-hero">
        <img src={post.data.heroImage} alt={post.data.title} />
      </figure>
    )}
  </header>

  <div class="post-layout-container">
    {toc.length > 0 && (
      <aside class="post-sidebar" id="toc-sidebar">
        <nav class="sticky-toc">
          <div class="toc-header">
            <span class="toc-title">{post.data.title}</span>
          </div>
          <ul>
            {toc.map((h) => (
              <li><a href={`#${h.slug}`}>{h.text}</a></li>
            ))}
          </ul>
        </nav>
      </aside>
    )}

    <div class="post-body">
      <Content />
      
      <footer class="post-footer">
        {tags.length > 0 && (
          <div class="post-tags">
            {tags.map(tag => <span class="tag">#{tag}</span>)}
          </div>
        )}
      </footer>
    </div>
  </div>

  <Lightbox selector=".post-body" gallery={post.data.lightbox?.gallery} />

  {toc.length > 0 && (
    <button id="toc-toggle" class="toc-toggle-btn toggle-btn" aria-label="Toggle Table of Contents">
      <span class="dot"></span>
      <span class="label">Contents</span>
    </button>
  )}

  <button id="screen-toggle" class="screen-toggle-btn toggle-btn" aria-label="Toggle Screen Mode">
    <span class="dot"></span>
    <span class="label">Screen</span>
  </button>
</article>

<script>
  function tagImageOrientation() {
    const images = document.querySelectorAll('.post-body img');
    images.forEach(img => {
      const imgElement = img as HTMLImageElement;
      if (imgElement.complete) {
        setOrientation(imgElement);
      } else {
        imgElement.onload = () => setOrientation(imgElement);
      }
    });
  }

  function setOrientation(img: HTMLImageElement) {
    const isHorizontal = img.naturalWidth > img.naturalHeight;
    img.classList.add(isHorizontal ? 'is-horizontal' : 'is-vertical');
    const figure = img.closest('figure');
    if (figure) {
      figure.classList.add(isHorizontal ? 'is-horizontal' : 'is-vertical');
    }
  }

  // Update menubar background and auto-captions
  function refineEssayContent() {
    const article = document.querySelector('.editorial-post') as HTMLElement;
    if (article) {
      // Background Sync
      const bgColor = getComputedStyle(article).getPropertyValue('--page-bg').trim();
      const header = document.querySelector('.site-header') as HTMLElement;
      if (header) {
        // Use a translucent version of the page background if possible, otherwise fallback to translucent white
        header.style.backgroundColor = 'rgba(249, 228, 228, 0.0)'; 
        header.style.backdropFilter = 'blur(6px)';
        header.style.webkitBackdropFilter = 'blur(6px)';
        header.style.borderBottom = '1px solid rgba(0,0,0,0.1)';
        header.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
        
        const headerInner = header.querySelector('.site-header-inner') as HTMLElement;
        if (headerInner) {
          headerInner.style.backgroundColor = 'transparent';
          headerInner.style.backdropFilter = 'none';
        }
      }

      // Auto-captions from alt text
      const images = article.querySelectorAll('.post-body img');
      images.forEach(img => {
        const imgEl = img as HTMLImageElement;
        if (imgEl.alt && !imgEl.closest('figure')?.querySelector('figcaption')) {
          const figure = imgEl.closest('figure') || document.createElement('figure');
          if (!imgEl.closest('figure')) {
            imgEl.parentNode?.insertBefore(figure, imgEl);
            figure.appendChild(imgEl);
          }
          const caption = document.createElement('figcaption');
          caption.className = 'image-caption';
          caption.textContent = imgEl.alt;
          figure.appendChild(caption);
        }
      });
    }
  }

  // Handle dropcaps and TOC toggle
  function initEditorialFeatures() {
    const article = document.querySelector('.editorial-post') as HTMLElement;
    if (!article) return;

    // TOC Toggle Logic
    const sidebar = document.getElementById('toc-sidebar');
    const toggle = document.getElementById('toc-toggle');
    if (sidebar && toggle) {
      if (!toggle.dataset.hasTocListener) {
        toggle.addEventListener('click', () => {
          sidebar.classList.toggle('is-open');
        });
        
        toggle.dataset.hasTocListener = 'true';
      }
    }

    // Screen Mode Toggle
    const screenToggle = document.getElementById('screen-toggle');
    if (screenToggle) {
      if (!screenToggle.dataset.hasScreenListener) {
        screenToggle.addEventListener('click', () => {
          const isMsgMode = document.body.classList.contains('screen-mode');
          
          if (isMsgMode) {
            // Turning OFF: Add exiting class first
            document.body.classList.add('screen-mode-exiting');
            document.body.classList.remove('screen-mode');
            screenToggle.classList.remove('active');
            
            // Remove exiting class after animation matches CSS (0.8s) + buffer
            setTimeout(() => {
              document.body.classList.remove('screen-mode-exiting');
            }, 1000);
          } else {
            // Turning ON
            document.body.classList.add('screen-mode');
            screenToggle.classList.add('active');
          }
        });
        screenToggle.dataset.hasScreenListener = 'true';
      }
    }

    // Over-the-top Dropcaps
    const dropcaps = article.querySelectorAll('.dropcap');
    dropcaps.forEach(p => {
      const text = p.textContent || "";
      if (text.length > 0) {
        const firstLetter = text.charAt(0);
        p.setAttribute('data-letter', firstLetter);
      }
    });
  }

  tagImageOrientation();
  refineEssayContent();
  initEditorialFeatures();
  
  document.addEventListener('astro:page-load', () => {
    tagImageOrientation();
    refineEssayContent();
    initEditorialFeatures();
  });
</script>
